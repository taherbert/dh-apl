{
  "classificationMatrix": [
    {
      "ability": "auto_attack",
      "arBehavior": "actions+=/auto_attack",
      "anniBehavior": "actions+=/auto_attack",
      "classification": "shared",
      "sharedApproach": "Already in default list before hero routing",
      "rationale": "Identical, no hero-tree dependency. Already shared."
    },
    {
      "ability": "disrupt",
      "arBehavior": "actions+=/disrupt,if=target.debuff.casting.react",
      "anniBehavior": "actions+=/disrupt,if=target.debuff.casting.react",
      "classification": "shared",
      "sharedApproach": "Already in default list before hero routing",
      "rationale": "Interrupt logic is universal. Already shared."
    },
    {
      "ability": "infernal_strike",
      "arBehavior": "use_off_gcd=1, unconditional",
      "anniBehavior": "use_off_gcd=1, unconditional",
      "classification": "shared",
      "sharedApproach": "Already in default list before hero routing",
      "rationale": "Off-GCD movement/damage. No hero-tree interaction. Already shared."
    },
    {
      "ability": "demon_spikes",
      "arBehavior": "use_off_gcd=1,if=!buff.demon_spikes.up&!cooldown.pause_action.remains",
      "anniBehavior": "use_off_gcd=1,if=!buff.demon_spikes.up&!cooldown.pause_action.remains",
      "classification": "shared",
      "sharedApproach": "Already in default list before hero routing",
      "rationale": "Defensive maintenance. Identical conditions. Already shared."
    },
    {
      "ability": "trinket1",
      "arBehavior": "!trinket.1.is.tome_of_lights_devotion&(!variable.trinket_1_buffs|(buff.metamorphosis.up|cooldown.metamorphosis.remains<10|cooldown.metamorphosis.remains>trinket.1.cooldown.duration|(variable.trinket_2_buffs&trinket.2.cooldown.remains<cooldown.metamorphosis.remains)))",
      "anniBehavior": "!trinket.1.is.tome_of_lights_devotion&(!variable.trinket_1_buffs|(buff.metamorphosis.up|cooldown.metamorphosis.remains<10|cooldown.metamorphosis.remains>trinket.1.cooldown.duration|(variable.trinket_2_buffs&trinket.2.cooldown.remains<cooldown.metamorphosis.remains)))",
      "classification": "shared",
      "sharedApproach": "Extract to actions.trinkets sub-list, call from both hero branches or from default list after variable setup",
      "rationale": "Logic is byte-for-byte identical between AR and Anni. Both sync trinkets to Meta windows. The tome_of_lights_devotion special case is also identical. No hero-tree-specific buff timing affects trinket usage — Meta is the universal sync point."
    },
    {
      "ability": "trinket2",
      "arBehavior": "Same as trinket1 pattern with slot=trinket2",
      "anniBehavior": "Same as trinket1 pattern with slot=trinket2",
      "classification": "shared",
      "sharedApproach": "Same as trinket1 — extract to actions.trinkets",
      "rationale": "Identical logic, just referencing slot 2 instead of slot 1. Same Meta sync strategy."
    },
    {
      "ability": "tome_of_lights_devotion",
      "arBehavior": "use_item,name=tome_of_lights_devotion,if=buff.inner_resilience.up",
      "anniBehavior": "use_item,name=tome_of_lights_devotion,if=buff.inner_resilience.up",
      "classification": "shared",
      "sharedApproach": "Include in actions.trinkets sub-list",
      "rationale": "Identical condition. Hero tree irrelevant for this trinket's activation."
    },
    {
      "ability": "potion",
      "arBehavior": "if=(buff.rending_strike.up&buff.glaive_flurry.up)|prev_gcd.1.reavers_glaive",
      "anniBehavior": "if=buff.voidfall_spending.stack=3",
      "classification": "separate",
      "sharedApproach": "Could use a variable: variable,name=burst_active,value=hero_tree.aldrachi_reaver?((buff.rending_strike.up&buff.glaive_flurry.up)|prev_gcd.1.reavers_glaive):(buff.voidfall_spending.stack=3) — but ternary adds complexity for little gain",
      "rationale": "Potion timing is fundamentally different. AR pots during the empowered window (both buffs active = peak damage, ~2-3 GCDs). Anni pots at Voidfall spending stack=3 (peak meteor burst). These represent structurally different burst windows: AR burst is a 2-GCD empowered cycle, Anni burst is a 3-stack Voidfall dump. A shared variable would obscure the intent."
    },
    {
      "ability": "externals",
      "arBehavior": "if=(buff.rending_strike.up&buff.glaive_flurry.up)|prev_gcd.1.reavers_glaive",
      "anniBehavior": "if=buff.voidfall_spending.stack=3",
      "classification": "separate",
      "sharedApproach": "Same as potion — could use variable,name=burst_active but adds indirection for 1-line savings",
      "rationale": "Same reasoning as potion. Externals sync to the same hero-specific burst windows."
    },
    {
      "ability": "metamorphosis",
      "arBehavior": "if=!buff.metamorphosis.up|buff.untethered_rage.up",
      "anniBehavior": "if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up",
      "classification": "conditionally_shared",
      "sharedApproach": "variable,name=meta_ok,value=!buff.metamorphosis.up|buff.untethered_rage.up; variable,name=meta_ok,op=min,value=!buff.voidfall_spending.up,if=hero_tree.annihilator. Then: metamorphosis,use_off_gcd=1,if=variable.meta_ok",
      "rationale": "Core logic is identical: cast when Meta is down OR UR proc available. Anni adds one extra guard: never during Voidfall spending (Mass Acceleration would overwrite stacks and waste meteor triggers). This is a clean case for a shared variable with a hero-tree-specific guard appended. The UR proc consumption is identical in both trees."
    },
    {
      "ability": "fiery_brand",
      "arBehavior": "In ar_cooldowns: if=talent.fiery_demise&(cooldown.fiery_brand.charges>=2|!dot.fiery_brand.ticking). Also in ar_brand_window context.",
      "anniBehavior": "Two locations: (1) In anni_voidfall: if=talent.fiery_demise&!dot.fiery_brand.ticking&(buff.voidfall_building.stack=2|buff.voidfall_spending.stack=3). (2) Outside Voidfall: if=talent.fiery_demise&!dot.fiery_brand.ticking",
      "classification": "conditionally_shared",
      "sharedApproach": "Could create variable,name=brand_ok with hero-tree conditions, but the placement in priority differs significantly. AR has Brand as part of a dedicated cooldown sub-list. Anni integrates Brand into the Voidfall state machine for alignment. Better to keep Brand placement hero-specific but share the Brand window extension logic.",
      "rationale": "The condition differs meaningfully: AR uses charges>=2 aggressively (Down in Flames double-charge optimization) and always casts if not ticking. Anni additionally aligns Brand to Voidfall phase transitions (building.stack=2 or spending.stack=3) for Fiery Demise + meteor synergy. The timing strategy is different enough that a shared variable would lose the Anni alignment benefit. However, the Charred Flesh brand extension logic (ImmAura during Brand) IS identical."
    },
    {
      "ability": "fiery_brand_extension (Charred Flesh)",
      "arBehavior": "ar_brand_window: ImmAura if !buff.immolation_aura.up → Soul Carver → Sigil of Spite if soul_fragments<=5 → Fel Dev if !empowered",
      "anniBehavior": "Inline: immolation_aura,if=talent.charred_flesh&dot.fiery_brand.ticking (line 149)",
      "classification": "conditionally_shared",
      "sharedApproach": "Could extract a shared brand_window sub-list for the ImmAura extension + fire CD sequencing. AR calls it; Anni does a subset inline. The ImmAura line specifically is identical in intent.",
      "rationale": "AR has a full brand_window sub-list that sequences fire-school CDs during Brand. Anni only does the ImmAura extension inline. This is because AR has the empowered cycle guard (don't channel FelDev during empowered) while Anni has the Voidfall spending guard (don't channel during spending). The ImmAura extension logic is truly shared but the CD sequencing within the window is hero-specific."
    },
    {
      "ability": "soul_carver",
      "arBehavior": "In ar_cooldowns: if=!talent.fiery_demise|variable.fiery_demise_active. Also in ar_brand_window unconditionally.",
      "anniBehavior": "if=soul_fragments<=3",
      "classification": "conditionally_shared",
      "sharedApproach": "Conditions differ significantly. AR ties to Fiery Demise window (cast during Brand for fire amp). Anni uses a simple fragment overflow guard. Could merge: soul_carver,if=(variable.fiery_demise_active|!talent.fiery_demise)&soul_fragments<=3 — but this loses the AR brand_window unconditional usage.",
      "rationale": "AR prioritizes Soul Carver in Brand windows for Fiery Demise value, with a fallback outside Brand (if=!talent.fiery_demise|variable.fiery_demise_active). Anni treats it as a fragment generator with overflow protection. The fragment guard (<=3) is a good practice for both trees but AR's current APL omits it in the cooldown list (only in brand_window it fires unconditionally). These should probably converge toward a merged condition but priority placement differs."
    },
    {
      "ability": "sigil_of_spite",
      "arBehavior": "In ar_cooldowns: if=soul_fragments<=5. In ar_brand_window: if=soul_fragments<=5.",
      "anniBehavior": "if=soul_fragments<=2+talent.soul_sigils",
      "classification": "conditionally_shared",
      "sharedApproach": "variable,name=spite_frag_guard,value=hero_tree.aldrachi_reaver?5:(2+talent.soul_sigils). Then: sigil_of_spite,if=soul_fragments<=variable.spite_frag_guard",
      "rationale": "Both trees use a fragment overflow guard but with different thresholds. AR uses <=5 (more aggressive, willing to overcap slightly since AR cycle accelerates fragment consumption). Anni uses <=2+talent.soul_sigils (tighter, because Anni needs to manage Voidfall cycle timing and excess fragments don't accelerate Voidfall). The structural logic is the same — a fragment guard — but the values reflect different resource economies."
    },
    {
      "ability": "fel_devastation",
      "arBehavior": "In ar_cooldowns: if=!buff.rending_strike.up&!buff.glaive_flurry.up",
      "anniBehavior": "if=!buff.voidfall_spending.up",
      "classification": "conditionally_shared",
      "sharedApproach": "variable,name=feldev_ok,value=1; variable,name=feldev_ok,op=set,value=!buff.rending_strike.up&!buff.glaive_flurry.up,if=hero_tree.aldrachi_reaver; variable,name=feldev_ok,op=set,value=!buff.voidfall_spending.up,if=hero_tree.annihilator. Then: fel_devastation,if=variable.feldev_ok",
      "rationale": "Both trees guard FelDev against channeling during their respective burst windows. AR prevents channeling during empowered buffs (wastes Rending Strike/Glaive Flurry GCDs). Anni prevents channeling during Voidfall spending (wastes meteor triggers from Soul Cleave). The pattern is identical — 'don't channel during hero burst' — but the specific buff check differs. A shared variable cleanly encodes this."
    },
    {
      "ability": "spirit_bomb",
      "arBehavior": "Multiple conditions: (1) if=soul_fragments>=3&variable.fiery_demise_active, (2) if=soul_fragments>=variable.spb_threshold. Also in ar_aoe: if=soul_fragments>=variable.spb_threshold",
      "anniBehavior": "Multiple contexts: (1) In anni_voidfall: if=buff.voidfall_spending.stack=3&soul_fragments>=variable.spb_threshold, (2) Outside: if=soul_fragments>=variable.spb_threshold",
      "classification": "conditionally_shared",
      "sharedApproach": "The base SBomb (soul_fragments>=variable.spb_threshold) is shared. The FD threshold drop (>=3 during fiery_demise_active) is AR-specific. The Voidfall spending trigger (stack=3) is Anni-specific. Could share the base SBomb line and have hero-specific SBomb-in-burst lines in separate contexts.",
      "rationale": "Spirit Bomb usage has a shared core: cast at threshold fragments. But each tree has a special burst context: AR drops threshold during Fiery Demise (3-frag SBomb worth it at 1.3x fire amp). Anni uses SBomb as a Voidfall meteor trigger at stack=3. The base threshold (spb_threshold variable) is already shared. The burst-context SBombs are inherently hero-specific because they serve different mechanical purposes (fire amp exploitation vs meteor trigger)."
    },
    {
      "ability": "fracture",
      "arBehavior": "Multiple contexts: (1) charges>=2&soul_fragments<spb_threshold (charge mgmt), (2) buff.metamorphosis.up (Meta priority), (3) ungated fallback. In ar_empowered: buff.rending_strike.up&buff.glaive_flurry.up (empowered Fracture). Also: !soul_fragments>=spb_threshold guard absent (uncapped confirmed +10.4%)",
      "anniBehavior": "Multiple contexts: (1) charges>=2&soul_fragments<spb_threshold (charge mgmt — identical), (2) !buff.voidfall_spending.up (non-spending), (3) ungated fallback. In anni_voidfall: buff.voidfall_building.stack=2&fury>=70 (Voidfall transition trigger)",
      "classification": "conditionally_shared",
      "sharedApproach": "Charge management (charges>=2&soul_fragments<spb_threshold) is identical — extractable. Meta priority (AR) vs non-spending guard (Anni) differ fundamentally. The ungated fallback is the same. Empowered Fracture (AR) and Voidfall transition Fracture (Anni) are completely hero-specific.",
      "rationale": "Fracture has 3 layers: (1) charge management — identical, both prevent charge cap while respecting fragment ceiling. (2) Priority Fracture — divergent: AR prioritizes Fracture in Meta for +1 frag/cast (+5.2% DPS), Anni avoids Fracture during Voidfall spending (wastes meteor GCDs) but uses it as the Voidfall building→spending transition trigger. (3) Fallback — identical. Layers 1 and 3 are shared; layer 2 is hero-specific."
    },
    {
      "ability": "felblade",
      "arBehavior": "Unconditional, after Fracture fallback (line 66): felblade",
      "anniBehavior": "Unconditional, after SBomb (line 160): felblade",
      "classification": "shared",
      "sharedApproach": "Identical ability, identical conditions (none). Only priority position differs.",
      "rationale": "Felblade is a Fury generator with no fragment interaction. Both trees use it unconditionally. The only difference is its position in the priority list: AR has it after all Fracture variants; Anni has it after SBomb but before ImmAura. Position matters for GCD efficiency but the ability logic itself is identical. In a shared sub-list, position is determined by the sub-list's internal ordering."
    },
    {
      "ability": "immolation_aura (Fallout)",
      "arBehavior": "if=talent.fallout (line 68), plus AoE: if=!buff.immolation_aura.up (line 100), plus brand window: if=!buff.immolation_aura.up",
      "anniBehavior": "if=talent.fallout (line 162), plus Charred Flesh: if=talent.charred_flesh&dot.fiery_brand.ticking (line 149)",
      "classification": "conditionally_shared",
      "sharedApproach": "The Fallout cast (if=talent.fallout) is identical. Charred Flesh extension is also mechanically identical but AR wraps it in a brand_window sub-list while Anni inlines it. Could share: immolation_aura,if=talent.fallout|(talent.charred_flesh&dot.fiery_brand.ticking)",
      "rationale": "ImmAura for Fallout fragments is identical between trees — same talent, same check, same purpose. The Charred Flesh brand extension is also the same mechanic (IA ticks extend Brand). AR wraps brand extension in a dedicated sub-list; Anni inlines it. The filler ImmAura (no condition or just !buff.up) is also identical. Only the brand window context (what else to do during Brand) differs."
    },
    {
      "ability": "sigil_of_flame",
      "arBehavior": "Unconditional (line 69)",
      "anniBehavior": "Unconditional (line 163)",
      "classification": "shared",
      "sharedApproach": "Identical. Extract to shared filler section.",
      "rationale": "No hero-tree dependency. Same ability, same lack of conditions. Position in priority is the only variable (determined by surrounding abilities in the list)."
    },
    {
      "ability": "soul_cleave",
      "arBehavior": "Filler (line 70). Also in ar_empowered: if=buff.glaive_flurry.up&!buff.rending_strike.up (empowered SC triggers Fury of the Aldrachi glaive slashes)",
      "anniBehavior": "Multiple: (1) In anni_voidfall: if=buff.voidfall_spending.up&buff.voidfall_spending.stack<3 (meteor trigger during spending), (2) Filler (line 164)",
      "classification": "conditionally_shared",
      "sharedApproach": "Filler SC is identical. Burst-context SC is completely hero-specific: AR uses it as the empowered cycle's second ability (triggers 3-12 glaive slashes), Anni uses it as the Voidfall spending dump (each triggers a meteor). Cannot share burst SC.",
      "rationale": "Soul Cleave serves dual purposes in both trees but the burst purpose differs fundamentally. In AR, empowered SC is the payload of the Art of the Glaive cycle (triggers Fury of the Aldrachi). In Anni, SC is the Voidfall stack consumer (triggers meteors). These are completely different mechanical roles despite being the same button. The filler usage (just spending Fury and consuming fragments) is identical."
    },
    {
      "ability": "throw_glaive",
      "arBehavior": "Unconditional filler (line 74)",
      "anniBehavior": "Unconditional filler (line 168)",
      "classification": "shared",
      "sharedApproach": "Extract to shared fillers",
      "rationale": "Pure filler. No hero-tree interaction. Identical in both."
    },
    {
      "ability": "vengeful_retreat",
      "arBehavior": "if=talent.unhindered_assault (line 73)",
      "anniBehavior": "Not present in Anni branch",
      "classification": "conditionally_shared",
      "sharedApproach": "Could add to Anni as well — Unhindered Assault is a class talent available to both trees. Currently missing from Anni, likely an oversight.",
      "rationale": "Vengeful Retreat with Unhindered Assault grants Fury and deals damage. It's a class talent not gated by hero tree. AR includes it, Anni does not. This is likely a bug in the Anni branch — the ability should appear as a filler in both branches when the talent is taken. Since it's talent-gated (not hero-gated), it belongs in shared fillers."
    },
    {
      "ability": "ur_fishing (sub-list)",
      "arBehavior": "ar_ur_fishing: SBomb if seething_anger&frags>=3 → SBomb if frags>=4 → Spite if frags<=2 → Soul Carver if frags<=2 → Fracture → SC if frags>=1",
      "anniBehavior": "anni_ur_fishing: identical — SBomb if seething_anger&frags>=3 → SBomb if frags>=4 → Spite if frags<=2 → Soul Carver if frags<=2 → Fracture → SC if frags>=1",
      "classification": "shared",
      "sharedApproach": "Merge into single actions.ur_fishing sub-list called from both branches. 100% identical logic.",
      "rationale": "Line-by-line identical. UR fishing is about maximizing Spirit Bomb proc attempts before Meta expires. The Seething Anger bad luck protection and the proc mechanics are identical regardless of hero tree. The Voidfall edge case (see urFishingAnalysis) does not currently justify divergence."
    },
    {
      "ability": "ar_empowered (sub-list)",
      "arBehavior": "Reaver's Glaive → empowered Fracture (both buffs) → empowered SC (GF up, RS down) → Fracture (RS up, GF down)",
      "anniBehavior": "Not applicable — Anni has no empowered cycle",
      "classification": "separate",
      "sharedApproach": "N/A — purely AR mechanic",
      "rationale": "Art of the Glaive is an Aldrachi Reaver-only state machine. Reaver's Glaive, Rending Strike, Glaive Flurry buffs don't exist in Annihilator. This is the core AR differentiator."
    },
    {
      "ability": "anni_voidfall (sub-list)",
      "arBehavior": "Not applicable — AR has no Voidfall mechanic",
      "anniBehavior": "Brand alignment → SBomb at spending=3 → SC to consume spending stacks → Fracture at building=2 with fury>=70 pooling",
      "classification": "separate",
      "sharedApproach": "N/A — purely Anni mechanic",
      "rationale": "Voidfall building→spending state machine is Annihilator-only. The stack tracking, meteor triggers, Mass Acceleration interaction, and fury pooling for phase transition are all unique to this hero tree."
    },
    {
      "ability": "ar_brand_window (sub-list)",
      "arBehavior": "ImmAura extension → Soul Carver → Sigil of Spite (frag guard) → Fel Dev (no empowered guard)",
      "anniBehavior": "No equivalent sub-list — Brand extension is inline (line 149)",
      "classification": "conditionally_shared",
      "sharedApproach": "The ImmAura extension line is identical. Could create a minimal shared brand_extension: just immolation_aura,if=!buff.immolation_aura.up. The fire CD sequencing (SC, Spite, FelDev) belongs in hero-specific cooldown handling because the guards differ.",
      "rationale": "AR wraps Charred Flesh brand extension + fire CD sequencing in a dedicated sub-list. Anni only does the ImmAura extension inline. The sub-list structure is AR-specific because it includes the empowered guard on Fel Dev. A shared 'brand extension' sub-list would only contain the ImmAura line, which is too small to justify a sub-list."
    },
    {
      "ability": "ar_aoe (sub-list)",
      "arBehavior": "Empowered cycle → Brand window → ImmAura priority → SBomb → Fracture Meta → SoF → Fracture → Felblade → SC → ImmAura → VR → TG",
      "anniBehavior": "No equivalent AoE sub-list — Anni uses single priority list",
      "classification": "separate",
      "sharedApproach": "AR AoE reprioritizes ImmAura to top for Fallout fragment gen at 3+ targets. Anni's single priority list handles AoE implicitly because Voidfall cycle doesn't change at higher target counts. Could consider an AoE variable for ImmAura priority in a shared context.",
      "rationale": "AR AoE sub-list exists because the priority ordering changes at 3+ targets: ImmAura becomes top priority for Fallout fragment generation. Anni doesn't need this because its priority list already handles AoE: Voidfall meteors scale via SBomb AoE radius and ImmAura Fallout is lower value when Voidfall cycle timing dominates. The AR AoE sub-list is an AR-specific optimization."
    },
    {
      "ability": "precombat",
      "arBehavior": "snapshot_stats → trinket variables → sigil_of_flame → immolation_aura",
      "anniBehavior": "snapshot_stats → trinket variables → sigil_of_flame → immolation_aura",
      "classification": "shared",
      "sharedApproach": "Already shared in actions.precombat",
      "rationale": "Precombat is identical. Both trees want to pre-cast SoF and ImmAura for immediate fragment generation and damage on pull."
    },
    {
      "ability": "variables (default list)",
      "arBehavior": "fiery_demise_active, spb_threshold, ur_fishing, fallout_aoe",
      "anniBehavior": "fiery_demise_active, spb_threshold, ur_fishing, fallout_aoe",
      "classification": "shared",
      "sharedApproach": "Already shared in default list",
      "rationale": "All four variables are used by both hero trees. fiery_demise_active and fallout_aoe are talent-gated (not hero-gated). spb_threshold is used identically (5, lowered to 4 during UR fishing). ur_fishing tracks the same Meta-expiring-without-UR-proc window."
    }
  ],

  "architectureProposal": {
    "approach": "Hybrid A+B: Shared core infrastructure + hero-specific main lists that call shared sub-lists",
    "rationale": "Pure Approach A (shared core + hero overlays) fails because the two trees have fundamentally different priority orderings for their core rotation. The AR empowered cycle must interrupt the normal priority at unpredictable times; the Anni Voidfall cycle adds a state machine layer that reshuffles cooldown timing. Pure Approach C (variable-driven unified list) would require so many hero_tree.X conditions that readability suffers and the risk of cross-contamination when editing one tree's logic is high. The hybrid approach keeps AR and Anni as independent main lists (easy to reason about each tree in isolation) while extracting genuinely shared logic into callable sub-lists. This gives the best combination of: (1) no code duplication for truly identical logic, (2) clear separation of hero-specific mechanics, (3) low risk of accidental cross-contamination.",

    "structure": {
      "actions.precombat": "Shared. snapshot_stats, trinket variables, SoF, ImmAura.",
      "actions (default)": "Shared variables (fiery_demise_active, spb_threshold, ur_fishing, fallout_aoe, meta_ok, feldev_ok), auto_attack, disrupt, infernal_strike, demon_spikes, hero tree routing via run_action_list.",
      "actions.trinkets": "NEW shared sub-list. Trinket1, Trinket2, Tome — identical for both trees. Called early in both AR and Anni lists.",
      "actions.externals": "Existing shared sub-list. invoke_external_buff. Already shared.",
      "actions.ur_fishing": "NEW shared sub-list (merge ar_ur_fishing + anni_ur_fishing). SBomb seething_anger, SBomb threshold, Spite/SC frag gen, Fracture, SC fallback.",
      "actions.fillers": "NEW shared sub-list. ImmAura (non-Fallout filler), Vengeful Retreat if unhindered_assault, Throw Glaive.",
      "actions.ar": "Hero-specific main list. Calls trinkets, potion+externals (AR burst timing), Meta (via meta_ok), ar_empowered, ar_brand_window, ur_fishing, ar_cooldowns, ar_aoe. Then inline: charge mgmt Fracture, FD SBomb, threshold SBomb, Meta Fracture, ungated Fracture, Felblade, Fallout ImmAura, SoF, SC filler, fillers.",
      "actions.ar_empowered": "Hero-specific. Unchanged — pure AR state machine.",
      "actions.ar_cooldowns": "Hero-specific. Brand, Spite, Soul Carver, FelDev (using feldev_ok variable).",
      "actions.ar_brand_window": "Hero-specific. ImmAura extension, Soul Carver, Spite, FelDev.",
      "actions.ar_aoe": "Hero-specific. Unchanged — AR AoE reprioritization.",
      "actions.anni": "Hero-specific main list. Calls trinkets, potion+externals (Anni burst timing), anni_voidfall, Meta (via meta_ok), ur_fishing. Then inline: Brand, Charred Flesh ImmAura, Spite, Soul Carver, FelDev (via feldev_ok), charge mgmt Fracture, SBomb, non-spending Fracture, Felblade, Fallout ImmAura, SoF, SC filler, ungated Fracture, fillers.",
      "actions.anni_voidfall": "Hero-specific. Unchanged — pure Anni state machine."
    },

    "sharedVariables": [
      {
        "name": "fiery_demise_active",
        "definition": "variable,name=fiery_demise_active,value=talent.fiery_brand&talent.fiery_demise&dot.fiery_brand.ticking",
        "location": "default list",
        "status": "already_shared"
      },
      {
        "name": "spb_threshold",
        "definition": "variable,name=spb_threshold,value=5 + op=set to 4 during UR fishing",
        "location": "default list",
        "status": "already_shared"
      },
      {
        "name": "ur_fishing",
        "definition": "variable,name=ur_fishing,value=talent.untethered_rage&buff.metamorphosis.up&buff.metamorphosis.remains<8&!buff.untethered_rage.up",
        "location": "default list",
        "status": "already_shared"
      },
      {
        "name": "fallout_aoe",
        "definition": "variable,name=fallout_aoe,value=talent.fallout&active_enemies>=3",
        "location": "default list",
        "status": "already_shared"
      },
      {
        "name": "meta_ok",
        "definition": "variable,name=meta_ok,value=!buff.metamorphosis.up|buff.untethered_rage.up\nvariable,name=meta_ok,op=min,value=!buff.voidfall_spending.up,if=hero_tree.annihilator",
        "location": "default list",
        "status": "proposed_new",
        "rationale": "Encodes Meta conditions for both trees. AR: cast when down or UR proc. Anni: same but NOT during Voidfall spending. The op=min (AND logic) cleanly appends the Anni guard without affecting AR."
      },
      {
        "name": "feldev_ok",
        "definition": "variable,name=feldev_ok,value=1\nvariable,name=feldev_ok,op=set,value=!buff.rending_strike.up&!buff.glaive_flurry.up,if=hero_tree.aldrachi_reaver\nvariable,name=feldev_ok,op=set,value=!buff.voidfall_spending.up,if=hero_tree.annihilator",
        "location": "default list",
        "status": "proposed_new",
        "rationale": "Both trees guard FelDev against their respective burst windows. Pattern: 'don't channel during hero burst'. Variable makes the guard readable and the pattern explicit."
      }
    ],

    "sharedSubLists": [
      {
        "name": "actions.trinkets",
        "contents": "use_item,slot=trinket1 (with Meta sync), use_item,slot=trinket2 (with Meta sync), use_item,name=tome_of_lights_devotion,if=buff.inner_resilience.up",
        "calledFrom": "Both AR and Anni, early in their lists",
        "linesSaved": 6,
        "riskAssessment": "Zero risk — logic is byte-for-byte identical. Any future trinket-specific logic (e.g., a trinket that synergizes with one hero tree) can use hero_tree.X conditions within the shared list."
      },
      {
        "name": "actions.ur_fishing",
        "contents": "SBomb if seething_anger&frags>=3, SBomb if frags>=4, Spite if frags<=2, Soul Carver if frags<=2, Fracture, SC if frags>=1",
        "calledFrom": "Both AR and Anni, guarded by if=variable.ur_fishing",
        "linesSaved": 6,
        "riskAssessment": "Very low risk — logic is identical. The Voidfall edge case (see urFishingAnalysis) doesn't justify divergence because UR fishing window is Meta-expiring and Voidfall spending is suppressed during Meta transition."
      },
      {
        "name": "actions.fillers",
        "contents": "immolation_aura (non-Fallout filler), vengeful_retreat if talent.unhindered_assault, throw_glaive",
        "calledFrom": "Both AR and Anni, at the bottom of their lists as fallback",
        "linesSaved": 4,
        "riskAssessment": "Low risk — these are bottom-of-list fillers with no hero-tree dependency. Also fixes the missing vengeful_retreat in Anni branch."
      }
    ],

    "heroSpecificLists": {
      "ar": [
        {
          "name": "actions.ar",
          "purpose": "Main AR rotation. Calls shared trinkets, handles AR-specific potion/external timing, routes to empowered/brand/ur_fishing/cooldown/aoe sub-lists, then core rotation + fillers."
        },
        {
          "name": "actions.ar_empowered",
          "purpose": "Art of the Glaive cycle spending. Reaver's Glaive → empowered Fracture → empowered Soul Cleave. Pure AR state machine, no shared equivalent."
        },
        {
          "name": "actions.ar_cooldowns",
          "purpose": "AR cooldown sequencing. Brand (charge management), Spite, Soul Carver (FD alignment), FelDev (empowered guard via feldev_ok variable)."
        },
        {
          "name": "actions.ar_brand_window",
          "purpose": "Charred Flesh brand extension. ImmAura → fire CDs during Brand. AR-specific because of empowered guard on FelDev."
        },
        {
          "name": "actions.ar_aoe",
          "purpose": "AR AoE reprioritization at 3+ targets. ImmAura top priority for Fallout fragment gen. Includes empowered cycle call."
        }
      ],
      "anni": [
        {
          "name": "actions.anni",
          "purpose": "Main Anni rotation. Calls shared trinkets, handles Anni-specific potion/external timing (Voidfall spending=3), routes to voidfall/ur_fishing, then cooldowns + core rotation + fillers."
        },
        {
          "name": "actions.anni_voidfall",
          "purpose": "Voidfall cycle state machine. Brand alignment → SBomb at spending=3 → SC to dump stacks → Fracture at building=2 with fury pooling. Pure Anni mechanic."
        }
      ]
    },

    "deletedLists": [
      {
        "name": "actions.ar_ur_fishing",
        "replacedBy": "actions.ur_fishing (shared)",
        "reason": "100% identical to anni_ur_fishing. Merged."
      },
      {
        "name": "actions.anni_ur_fishing",
        "replacedBy": "actions.ur_fishing (shared)",
        "reason": "100% identical to ar_ur_fishing. Merged."
      }
    ],

    "netImpact": {
      "linesRemoved": "~16 (duplicated trinkets ×6, UR fishing ×6, fillers ×4)",
      "linesAdded": "~12 (shared trinkets sub-list ×3, shared ur_fishing ×6, shared fillers ×3, meta_ok variable ×2, feldev_ok variable ×3)",
      "netChange": "-4 lines",
      "subListCount": {
        "before": 9,
        "after": 10,
        "breakdown": "Removed ar_ur_fishing + anni_ur_fishing (-2), Added trinkets + ur_fishing + fillers (+3) = net +1"
      },
      "readabilityAssessment": "Improved. Shared logic is labeled as shared, reducing cognitive load when editing one tree. The trinkets sub-list is the clearest win: anyone reading the AR or Anni list immediately sees 'call trinkets' rather than 6 lines of trinket logic they need to mentally verify matches the other tree."
    }
  },

  "urFishingAnalysis": {
    "currentlyIdentical": true,
    "shouldDiffer": false,
    "voidfallEdgeCase": {
      "scenario": "UR fishing active (Meta about to drop, <8s remaining) AND Voidfall spending is active (1-3 stacks)",
      "frequency": "Very rare. UR fishing only happens in the last ~8s of a 15s Meta window. Voidfall spending lasts for ~3 GCDs (3 Soul Cleave triggers). The overlap window is ~2-3 seconds.",
      "mechanicalAnalysis": "During UR fishing, priority is SBomb at 3-4 frags for maximum proc attempts. If Voidfall spending is active, Soul Cleave triggers meteors (each SC consumes 1 spending stack → meteor). The question: should we interrupt UR fishing SBomb priority to dump Voidfall stacks via Soul Cleave first?",
      "dpsAnalysis": "Voidfall meteor damage (~0.5-1% of total DPS per meteor) vs UR proc value (refreshing Meta = 15s of 20% damage amp + 3 frags per Fracture). At the margin, a single UR proc is worth more than 1-3 meteors. The UR fishing SBomb also consumes fragments and triggers meteors if Voidfall spending is active (SBomb is a valid Voidfall trigger). So SBomb during UR fishing ALSO triggers a meteor — no waste.",
      "interactionDetail": "Spirit Bomb at Voidfall spending stack=3 triggers a meteor (it's a fragment consumer, which triggers Voidfall spending). So the UR fishing SBomb sequence naturally interacts with Voidfall: SBomb at 3+ frags during spending = meteor trigger + UR proc attempt. No conflict.",
      "edgeEdgeCase": "What if spending stack is 1 or 2 (not 3) during UR fishing? SC would trigger individual meteors to reduce stacks toward 0. But UR fishing already has SC as a fallback (soul_cleave,if=soul_fragments>=1). This SC line would naturally dump remaining Voidfall stacks as part of the fishing rotation. Again, no conflict.",
      "conclusion": "UR fishing and Voidfall spending interact naturally through shared ability triggers. SBomb triggers both UR proc attempts and Voidfall meteors. SC triggers both UR proc attempts (weaker) and Voidfall meteor dumps. The existing UR fishing priority list handles both mechanics simultaneously without needing hero-specific modifications."
    },
    "proposal": {
      "recommendation": "shared",
      "implementation": "Merge ar_ur_fishing and anni_ur_fishing into a single actions.ur_fishing sub-list. Call it from both branches with if=variable.ur_fishing.",
      "reasoning": "The logic is byte-for-byte identical. The Voidfall edge case analysis shows no mechanical conflict — abilities that serve UR fishing also serve Voidfall meteor triggers. Maintaining two copies creates maintenance burden (any UR fishing tuning must be applied to both) with zero benefit.",
      "futureConsideration": "If a future patch changes UR proc mechanics to interact differently with hero tree buffs, this decision should be revisited. Currently there is no such interaction."
    }
  },

  "implementationPriority": [
    {
      "change": "Merge UR fishing sub-lists",
      "effort": "trivial",
      "impact": "Eliminates 6 duplicate lines, zero DPS risk",
      "priority": 1
    },
    {
      "change": "Extract trinkets to shared sub-list",
      "effort": "low",
      "impact": "Eliminates 6 duplicate lines, zero DPS risk",
      "priority": 2
    },
    {
      "change": "Add shared fillers sub-list (fixes missing VR in Anni)",
      "effort": "low",
      "impact": "Eliminates 4 duplicate lines + fixes a bug (missing Vengeful Retreat in Anni)",
      "priority": 3
    },
    {
      "change": "Add meta_ok shared variable",
      "effort": "low",
      "impact": "Clarifies Meta logic, makes Anni Voidfall guard explicit in variable form",
      "priority": 4
    },
    {
      "change": "Add feldev_ok shared variable",
      "effort": "low",
      "impact": "Clarifies FelDev guard pattern across trees",
      "priority": 5
    }
  ],

  "riskAssessment": {
    "crossContamination": "LOW. The hybrid approach keeps hero-specific mechanics (empowered cycle, Voidfall state machine) in separate sub-lists. Shared sub-lists only contain truly identical logic (trinkets, UR fishing, fillers). Editing a shared sub-list requires considering both trees, but this is appropriate — if the logic is shared, changes should affect both trees.",
    "accidentalBehaviorChange": "MINIMAL. All proposed shared extractions are verified identical. The only behavioral change is the Vengeful Retreat addition to Anni (currently missing = bug fix, not behavior change to existing logic).",
    "performanceCost": "NEGLIGIBLE. call_action_list has zero GCD/overhead (use_off_gcd=true, use_while_casting=true). Additional sub-list calls add condition evaluations but SimC handles this efficiently. The variable evaluations (meta_ok, feldev_ok) add ~2 condition checks per cycle — unmeasurable.",
    "maintenanceBenefit": "MODERATE. The primary benefit is that changes to trinket logic, UR fishing tuning, or filler ordering only need to be made once. Currently, these must be manually synchronized across both branches."
  }
}
