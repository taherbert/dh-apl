{
  "focus": "resource_flow",
  "analyzedAt": "2026-02-09",
  "dataInputs": [
    "data/vengeance/spells-summary.json",
    "data/vengeance/cpp-proc-mechanics.json",
    "data/vengeance/interactions-summary.json",
    "src/spec/vengeance.js (SPEC_CONFIG)",
    "apls/vengeance/vengeance.simc"
  ],

  "fury_economy": {
    "summary": "Fury is NOT the binding constraint in steady-state. Fragment availability gates SBomb casts more than Fury does. Fury surplus exists in most scenarios, especially with Darkglare Boon refunding 15-30 Fury on FelDev completion.",

    "generation": {
      "at_20pct_haste": {
        "gcd_duration_s": 1.25,
        "notes": "GCD = 1.5 / 1.2 = 1.25s at 20% haste. Charge-based abilities: recharge_time / 1.2"
      },

      "fracture": {
        "fury_per_cast_normal": 25,
        "fury_per_cast_meta": 40,
        "charges": 2,
        "base_recharge_s": 6,
        "pbg_recharge_s": 5,
        "hasted_recharge_s_at_20pct": 4.17,
        "sustained_casts_per_min": 28.8,
        "sustained_fury_per_min_normal": 720,
        "sustained_fury_per_min_meta": 1152,
        "notes": "With PBG talent (-1s), base recharge is 5s. At 20% haste: 5/1.2 = 4.17s. Sustained rate = 2 charges / 4.17s = 0.48 casts/s = 28.8/min. In practice, GCD-limited to ~1 per 1.25s = 48/min max, but charge recovery is the real gate. Not every GCD goes to Fracture."
      },
      "immolation_aura": {
        "fury_on_cast": 8,
        "fury_per_tick": 3,
        "tick_interval_s": 1,
        "duration_s": 6,
        "ticks_per_cast": 6,
        "total_fury_per_cast": 26,
        "charges": 2,
        "base_recharge_s": 30,
        "hasted_recharge_s": 25,
        "sustained_fury_per_min": 62.4,
        "notes": "8 fury initial + 6 ticks * 3 fury = 26 per cast. 2 charges / 25s = 0.08 casts/s = 4.8/min at 20% haste. However, with Agonizing Flames (+50% duration to 9s), ticks increase to 9 giving 35 fury/cast. With Aura of Pain (+5 fury over duration), 31 fury/cast. Exact value varies by talent."
      },
      "felblade": {
        "fury_per_cast": 15,
        "cooldown_s": 12,
        "hasted_gcd": false,
        "casts_per_min": 5,
        "fury_per_min": 75,
        "notes": "CD is not haste-reduced. 12s flat CD. AR gets extra casts via Unhindered Assault (reset on VR)."
      },
      "sigil_of_flame": {
        "fury_per_cast": 25,
        "cooldown_s": 30,
        "hasted_cd": false,
        "casts_per_min": 2,
        "fury_per_min": 50,
        "notes": "Cycle of Binding reduces CD by ~20% (to 24s). With CoB: 2.5 casts/min = 62.5 fury/min."
      },
      "tactical_retreat": {
        "fury_total": 80,
        "over_duration_s": 10,
        "fury_per_sec": 8,
        "cooldown_s": 20,
        "fury_per_min": 240,
        "notes": "8 fury/tick * 10s = 80 fury. CD 25s base, talent -5s = 20s. AR builds with Unhindered Assault always take this."
      },
      "darkglare_boon_refund": {
        "fury_refund_range": [15, 30],
        "average_refund": 22.5,
        "feldev_cd_base": 40,
        "effective_feldev_cd_with_cdr": 34,
        "fury_per_min_from_refund": 39.7,
        "notes": "Refunds 15-30% of FelDev CD (6-12s) AND 15-30 Fury. At 40s base CD, average CD becomes ~34s with the CDR portion."
      },
      "volatile_flameblood": {
        "fury_per_proc": "1-2 (random range from spell data)",
        "proc_condition": "IA crit, once per ~0.6s ICD",
        "estimated_fury_per_min": "15-25 (highly variable by crit rate)",
        "notes": "Generates fury on IA critical strikes. ICD prevents rapid stacking. Minor contributor."
      },

      "total_steady_state_fury_per_min": {
        "conservative_no_meta": 947,
        "breakdown": "Fracture(720) + IA(62.4) + Felblade(75) + SigFlame(50) + TacRetreat(~80/min avg) = ~987",
        "with_darkglare": 1027,
        "notes": "This exceeds consumption significantly. The surplus means Fury is rarely the limiting factor for spender casts."
      }
    },

    "consumption": {
      "spirit_bomb": {
        "cost": 40,
        "cooldown_s": 25,
        "casts_per_min": 2.4,
        "fury_per_min": 96,
        "notes": "Hard-gated by 25s CD, not by fury. Even at 3-frag FD casts, still only 40 fury."
      },
      "soul_cleave": {
        "cost": 35,
        "no_cd": true,
        "fury_per_min_estimate": "105 (3 casts/min filler usage)",
        "notes": "Used as filler spender and for AR empowered cycle. Frequency varies heavily by build."
      },
      "fel_devastation": {
        "cost": 50,
        "cooldown_s": 40,
        "casts_per_min": 1.5,
        "fury_per_min": 75,
        "notes": "With Darkglare Boon, effective cost is 50 - 22.5 = 27.5 fury net. With Stoke the Flames always taken in FelDev cluster."
      },
      "throw_glaive": {
        "cost": 25,
        "cooldown_s": 9,
        "casts_per_min": 6.67,
        "fury_per_min": 167,
        "notes": "Surprising fury drain. TG costs 25 fury with 9s CD (3s with MoTG charges). As a filler, this is the biggest fury sink. In AR, Reaver's Glaive replaces some TG casts."
      },

      "total_steady_state_fury_per_min": {
        "estimate": 443,
        "breakdown": "SBomb(96) + SC(105) + FelDev(75) + TG(167) = 443",
        "notes": "Generation (~987) far exceeds consumption (~443). The 544 fury/min surplus means fury overcapping IS a real risk. Unrestrained Fury (+20 cap to 120) helps but doesn't fully solve overcapping during burst windows."
      }
    },

    "equilibrium_analysis": {
      "fury_surplus_per_min": 544,
      "waste_risk": "HIGH during Meta (Fracture generates 40 fury instead of 25, +60% per cast)",
      "meta_fury_rate": "40 * 28.8 casts/min theoretical = 1152/min, but GCD-limited",
      "binding_constraint": "Soul Fragments, not Fury. Fragment generation rate gates SBomb frequency. Fury surplus simply means more Soul Cleave filler casts.",
      "implications": [
        "Fury pooling before SBomb is rarely necessary outside FD windows",
        "The anni_voidfall fury>=70 gate (line 147) is conservative but correct: ensures 40 fury for SBomb + 30 buffer for next Fracture",
        "Throw Glaive as 25-fury filler is a significant drain that competes with spender availability"
      ]
    }
  },

  "fragment_economy": {
    "summary": "Soul Fragments are the true binding constraint. Cap of 6 creates frequent waste, especially during burst generation windows (Soul Carver + Fracture + Fallout simultaneously). The APL's spb_threshold=5/4(meta) is a compression strategy to minimize cap waste.",

    "generation_by_scenario": {
      "single_target": {
        "fracture_normal": {
          "frags_per_cast": 2,
          "sustained_casts_per_min": 28.8,
          "frags_per_min": 57.6
        },
        "fracture_meta": {
          "frags_per_cast": 3,
          "sustained_casts_per_min": 28.8,
          "frags_per_min": 86.4,
          "notes": "Meta Fracture at 3 frags is the highest density generator. At cap 6, 2 Fractures = 6 frags = cap hit."
        },
        "soul_carver": {
          "frags_immediate": 3,
          "frags_over_dot": "1 per sec for 3s = 3 more",
          "total_frags": 6,
          "cooldown_s": 60,
          "frags_per_min": 6,
          "notes": "Soul Carver alone generates a full cap of fragments over 3s. This is why SC must be preceded by a SBomb at >=3 frags."
        },
        "sigil_of_spite": {
          "frags": 3,
          "cooldown_s": 60,
          "frags_per_min": 3,
          "notes": "Plus 1 from Soul Sigils if talented (4 total)."
        },
        "fallout_st": {
          "proc_rate": 1.0,
          "notes": "In ST, Fallout always procs on IA initial burst (100% at 1 target). Per tick = 0 in ST (only initial).",
          "frags_per_ia_cast": 1,
          "ia_casts_per_min": 4.8,
          "frags_per_min": 4.8
        },
        "soul_splitter": {
          "proc_rate": 0.02,
          "notes": "2% chance per fragment generation event. ~1.4 extra frags/min at 70 generation events/min."
        },
        "total_frags_per_min_st": 73,
        "breakdown_st": "Fracture(57.6) + SC(6) + Spite(3) + Fallout(4.8) + SoulSplitter(1.4) = 72.8"
      },
      "five_targets": {
        "fracture_normal": { "frags_per_min": 57.6, "notes": "Fracture frags unchanged by target count" },
        "fallout_5t": {
          "proc_rate_per_target": 0.6,
          "targets": 5,
          "expected_procs_per_burst": 3.0,
          "ia_casts_per_min": 4.8,
          "frags_per_min": 14.4,
          "notes": "Each IA initial hit per target has 60% chance. At 5 targets: expected 3.0 frags per IA cast. MASSIVE fragment pressure."
        },
        "soul_carver": { "frags_per_min": 6 },
        "sigil_of_spite": { "frags_per_min": 3 },
        "total_frags_per_min_5t": 82.4,
        "notes": "At 5 targets, Fallout alone creates enormous overcap pressure. Every IA burst dumps 3 frags into a pool that may already have 2-4."
      },
      "ten_targets": {
        "fallout_10t": {
          "expected_procs_per_burst": 5.2,
          "notes": "At 10 targets: 1 guaranteed + 9*0.6 = 6.4. But capped by fragment cap (6). Massive waste if pool > 0."
        },
        "frags_per_min_10t": "Theoretical 91+, but hard-capped by fragment inventory (6). Waste is extreme.",
        "waste_analysis": "At 10T, every IA burst generates 6+ frags. If even 1 frag exists pre-burst, waste occurs. This is unavoidable."
      }
    },

    "consumption": {
      "spirit_bomb": {
        "max_consume": 5,
        "cooldown_s": 25,
        "frags_consumed_per_min": 12,
        "notes": "At 2.4 casts/min consuming 5 frags each = 12/min. This is FAR below the 73/min generation rate in ST."
      },
      "soul_cleave": {
        "max_consume": 2,
        "no_cd": true,
        "frags_consumed_per_min_estimate": 6,
        "notes": "Roughly 3 casts/min consuming 2 frags = 6/min. SC consumes frags on the way through."
      },
      "total_consumption_per_min": 18,
      "notes": "Generation (73/min ST) far exceeds consumption (18/min). The delta of 55 frags/min represents overcap waste."
    },

    "overcap_analysis": {
      "waste_rate_st": "55 frags/min wasted at cap in steady state",
      "waste_rate_5t": "64 frags/min wasted at cap",
      "waste_significance": "Each wasted frag is a lost SBomb damage unit worth 20% per-frag scaling. However, the 25s SBomb CD is the hard gate.",
      "key_insight": "The real optimization isn't 'generate more frags' (we already overcap). It's 'time consumption correctly'. The spb_threshold variable (5 normal, 4 meta) controls the consumption trigger point.",
      "meta_threshold_reasoning": "At threshold=4 in Meta: Fracture(3 frags) + existing pool. If pool=1, Fracture->SBomb at 4 frags in 2 GCDs. At threshold=5: need pool>=2 before Fracture, or 2 Fractures (4 GCDs, 6 frags, 1 wasted). Threshold=4 saves ~1 GCD per cycle.",
      "cap_waste_with_soul_carver": "SC generates 6 frags over 3s. If cast at 0 frags, first 3 land immediately and 3 more over dot. If cast at 1+ frags, waste is nearly guaranteed. APL correctly gates SC behind soul_fragments<=3."
    }
  },

  "gcd_budget": {
    "summary": "At 20% haste, 48 GCDs/min available. Mandatory rotation consumes ~35-40 GCDs, leaving 8-13 discretionary GCDs for fillers. The GCD budget is tight but not oversaturated.",

    "gcd_per_min_at_20pct_haste": 48,
    "gcd_duration_s": 1.25,

    "mandatory_abilities": {
      "fracture": {
        "gcds_per_min": 14.4,
        "notes": "2 charges / 4.17s recharge = 0.48 cast/s = 28.8/min theoretical. GCD-limited to ~24/min. In practice, ~14 casts/min due to priority conflicts and frag cap management."
      },
      "spirit_bomb": {
        "gcds_per_min": 2.4,
        "notes": "25s CD = 2.4 casts/min. Always cast on CD when frags available."
      },
      "sigil_of_flame": {
        "gcds_per_min": 2.0,
        "notes": "30s CD. With CoB: 2.5/min."
      },
      "soul_cleave": {
        "gcds_per_min": 3.0,
        "notes": "No CD, used as fury dump and AR empowered ability. AR builds cast more due to cycle."
      }
    },

    "conditional_abilities": {
      "fel_devastation": {
        "gcds_consumed": 2,
        "frequency_per_min": 1.5,
        "total_gcds_per_min": 3.0,
        "notes": "2s channel = 1.6 GCDs at 1.25s GCD, but effectively 2 GCDs since you lose the channel time. 40s CD = 1.5/min. With Darkglare Boon CDR: ~1.76/min = 3.5 GCDs/min."
      },
      "soul_carver": {
        "gcds_per_min": 1.0,
        "notes": "60s CD. Only used in SC cluster builds."
      },
      "fiery_brand": {
        "gcds_per_min": 1.0,
        "notes": "60s CD base, 48s with Down in Flames. DiF builds: 1.25/min."
      },
      "sigil_of_spite": {
        "gcds_per_min": 1.0,
        "notes": "60s CD."
      },
      "immolation_aura": {
        "gcds_per_min": 4.8,
        "notes": "2 charges / 25s = 4.8/min. BUT IA is flagged as off-GCD in SPEC_CONFIG.offGcdAbilities. May not consume GCDs in SimC. If it does use GCD: this is a huge budget item."
      },
      "metamorphosis": {
        "gcds_per_min": 0.5,
        "notes": "120s CD, off-GCD cast (gcd: 0 in spell data). Does NOT consume a GCD."
      }
    },

    "filler_abilities": {
      "felblade": {
        "gcds_per_min": 5.0,
        "notes": "12s CD. AR gets extra from Unhindered Assault resets."
      },
      "throw_glaive": {
        "gcds_per_min": "3-6",
        "notes": "9s CD base, 2 charges with MoTG/Champion. Costs 25 fury. Primary filler."
      },
      "vengeful_retreat": {
        "gcds_per_min": 3.0,
        "notes": "20s CD with Tactical Retreat. Off-GCD (gcd: 0). Does NOT consume GCDs."
      }
    },

    "budget_allocation": {
      "scenario_full_stack_ar": {
        "mandatory": "Fracture(14.4) + SBomb(2.4) + SigFlame(2.0) + SC filler(3.0) = 21.8",
        "conditional": "FelDev(3.0) + SoulCarver(1.0) + Brand(1.25) + Spite(1.0) = 6.25",
        "total_committed": 28.05,
        "discretionary": 19.95,
        "filler_demand": "Felblade(5.0) + TG(4.0) + IA(4.8 if on-GCD) = 13.8",
        "surplus_gcds": "6.15 (if IA is on-GCD) or 10.95 (if IA is off-GCD)",
        "notes": "Budget is comfortable. Dead GCDs are unlikely with the current filler chain."
      },
      "scenario_anni_building": {
        "mandatory": "Fracture(14.4) + SBomb(2.4) + SigFlame(2.0) + SC filler(3.0) = 21.8",
        "conditional": "FelDev(3.5) + Brand(1.25) + Spite(1.0) = 5.75",
        "total_committed": 27.55,
        "discretionary": 20.45,
        "notes": "Anni has slightly more budget since AR cycle adds empowered Fracture/SC/RG mandatory casts."
      },
      "ar_empowered_cycle_overhead": {
        "gcds_per_cycle": 3,
        "cycle_frequency": "Every 20 frags consumed or Spite cast. ~3 cycles/min.",
        "gcds_per_min": 9,
        "notes": "RG(1) + empowered Fracture(1) + empowered SC(1) = 3 GCDs per cycle. These replace existing Fracture/SC casts, so net overhead is only RG = 1 GCD per cycle = 3/min."
      }
    },

    "feldev_gcd_cost_during_meta": {
      "meta_duration_s_base": 15,
      "meta_duration_s_vb": 20,
      "meta_gcds_base": 12,
      "meta_gcds_vb": 16,
      "feldev_gcds_lost": 1.6,
      "feldev_pct_of_meta_base": "13.3% of Meta GCDs lost to channel",
      "feldev_pct_of_meta_vb": "10% of Meta GCDs lost to channel",
      "feldev_damage_vs_lost_gcds": "FelDev deals ~1.54x AP * 1.3 (Stoke) * 1.15 (FD) over channel. Two lost Meta GCDs of Fracture = 2 * 1.035 * 1.2(Meta) AP. FelDev: 2.31 AP total. Lost Fractures: 2.48 AP total. FelDev LOSES slightly in raw damage during Meta, BUT it generates frags (Meteoric Rise: 3 frags) and procs 4pc.",
      "conclusion": "FelDev during Meta is approximately break-even in isolation. The fragment generation and 4pc proc value tilt it positive. Current APL correctly avoids FelDev during Voidfall spending but allows it otherwise."
    }
  },

  "cooldown_alignment": {
    "summary": "The cooldown ecology has natural alignment points but no clean LCM supercycle. Brand(60s) and SC(60s) align perfectly. FelDev(40s) aligns with Brand every 120s. Meta(120s) is the master alignment point. The key tension is Brand holding cost vs. fire CD alignment gain.",

    "cooldown_periods": {
      "metamorphosis": { "cd_s": 120, "duration_s": 15, "with_vb_s": 20 },
      "fiery_brand": { "cd_s": 60, "with_dif_s": 48, "with_dif_2charges": true, "duration_s": 10 },
      "fel_devastation": { "cd_s": 40, "with_dgb_effective_s": 34 },
      "spirit_bomb": { "cd_s": 25 },
      "soul_carver": { "cd_s": 60 },
      "sigil_of_spite": { "cd_s": 60 }
    },

    "lcm_analysis": {
      "brand_sc": "LCM(60, 60) = 60s. Perfect alignment every cast.",
      "brand_feldev": "LCM(60, 40) = 120s. Every 3rd FelDev aligns with Brand. Every 2nd Brand has FelDev.",
      "brand_dif_feldev": "LCM(48, 40) = 240s. Worse alignment with DiF.",
      "meta_brand": "LCM(120, 60) = 120s. Every Meta aligns with Brand.",
      "meta_feldev": "LCM(120, 40) = 120s. Every Meta aligns with FelDev (3rd FelDev cast).",
      "full_supercycle": "LCM(120, 60, 40, 25) = 600s (10 min). Complete alignment is rare in practical fights.",
      "notes": "The 120s Meta period is the natural alignment anchor. Brand+SC+FelDev all have alignment opportunities at Meta."
    },

    "brand_holding_cost": {
      "brand_damage_per_cast_ap": 0.4,
      "brand_fd_amp": 0.15,
      "holding_cost_formula": "damage_per_cast / cooldown^2 = ~small direct, but opportunity cost of FD window is large",
      "detailed_analysis": {
        "brand_direct_damage_is_negligible": true,
        "fd_window_value_per_second": {
          "abilities_in_window": ["Soul Carver (2.08 AP)", "FelDev (1.54*1.3=2.0 AP)", "SBomb (~2.0 AP at 5 frags)", "Fracture (1.035 AP)", "SigFlame (0.792 AP)", "IA ticks"],
          "total_fire_damage_in_10s_window_ap": 8.0,
          "fd_amp_value_per_window": "8.0 * 0.15 = 1.2 AP amplification per Brand window",
          "notes": "With Vulnerability/Soulcrush Frailty stacking, Brand window also benefits from the 6% target damage amp."
        },
        "holding_brand_for_meta": {
          "scenario": "Brand CD=60s, Meta CD=120s. Brand has 2 casts per Meta cycle. Holding 1st Brand for Meta wastes up to 10s of Brand CD.",
          "max_hold_s": 10,
          "holding_cost": "0.12 AP/s of FD value lost (1.2 AP / 10s)",
          "alignment_gain": "Meta 1.2x damage multiplier on all fire damage in the Brand window",
          "meta_amped_fd_window": "8.0 * 0.15 * 1.2 = 1.44 AP. Gain = 1.44 - 1.2 = 0.24 AP from alignment",
          "break_even_hold_s": 2.0,
          "conclusion": "Holding Brand more than ~2s for Meta is net negative. The current APL does not hold Brand for Meta (correct behavior)."
        },
        "holding_brand_for_fire_cds": {
          "scenario": "Brand ready but SC/FelDev 6s away. APL condition: cooldown.soul_carver.remains<6 | cooldown.fel_devastation.remains<6",
          "max_hold_s": 6,
          "gain_from_having_sc_in_window": "2.08 * 0.15 = 0.312 AP gain",
          "cost_of_6s_hold": "0.72 AP lost FD uptime (1.2 AP * 6/10 partial)",
          "net_at_6s_hold": "+0.312 - 0.72 = -0.41 AP. NEGATIVE at max hold.",
          "net_at_3s_hold": "+0.312 - 0.36 = -0.05 AP. Approximately break-even.",
          "conclusion": "The <6 condition is too generous. SC or FelDev worth waiting ~3s max. However, the APL also requires charges>=2 OR !dot.fiery_brand.ticking, which means it prefers spending a charge immediately and holding the second. This is correct behavior."
        }
      }
    },

    "meta_hold_cost_quantification": {
      "meta_damage_amp": 0.20,
      "meta_duration_base_s": 15,
      "meta_duration_vb_s": 20,
      "meta_total_gcds_base": 12,
      "meta_total_gcds_vb": 16,

      "dps_value_per_meta_gcd": {
        "with_vb": "Each Meta GCD benefits from +20% base + VB +20% to Fracture/SC/SBomb = multiplicative 1.44x on key abilities",
        "without_vb": "Each Meta GCD benefits from +20% base only = 1.20x on all abilities",
        "average_ability_ap_per_gcd": 1.5,
        "dps_uplift_per_gcd_with_vb": "1.5 * 0.44 = 0.66 AP extra per GCD",
        "dps_uplift_per_gcd_without_vb": "1.5 * 0.20 = 0.30 AP extra per GCD"
      },

      "cost_per_second_of_delay": {
        "with_vb": "0.66 AP/GCD * (16 GCDs / 20s) = 0.528 AP/s opportunity cost",
        "without_vb": "0.30 AP/GCD * (12 GCDs / 15s) = 0.24 AP/s opportunity cost",
        "ratio": "VB Meta delay costs 2.2x more than non-VB Meta delay"
      },

      "anni_building_stack_hold": {
        "current_apl_condition": "buff.voidfall_building.stack<2 (Meta fires at 0-1 stacks)",
        "hold_at_2_stacks": {
          "expected_fractures_to_complete_stack": "1/0.35 = 2.86 Fractures on average",
          "expected_time_to_complete_s": "2.86 * 1.25 GCDs = 3.57s average wait",
          "worst_case_wait_s": "Up to 10s (very unlucky streak)",
          "cost_at_3s_with_vb": "3.0 * 0.528 = 1.58 AP lost",
          "cost_at_3s_without_vb": "3.0 * 0.24 = 0.72 AP lost"
        },
        "gain_from_double_burst": {
          "mass_acceleration_grants": "3 Voidfall stacks (immediate full spending)",
          "voidfall_meteor_damage_per_stack": "~1.5 AP per meteor (base, before modifiers)",
          "three_meteors_total": "4.5 AP from second spending phase",
          "plus_world_killer_on_3rd": "+50% damage = 2.25 AP extra on 3rd meteor",
          "total_gain_from_double_burst": "4.5 + 2.25 = 6.75 AP (before modifiers)",
          "with_meta_amp_20pct": "6.75 * 1.2 = 8.1 AP"
        },
        "analysis_by_build": {
          "with_vb": {
            "break_even_hold_s": "8.1 / 0.528 = 15.3s. Any hold under 15s is profitable.",
            "conclusion": "Hold at building=2 is STRONGLY positive with VB. Expected 3.6s wait gives 8.1 - 1.9 = +6.2 AP net."
          },
          "without_vb": {
            "break_even_hold_s": "8.1 / 0.24 = 33.8s. Even more profitable since hold cost is lower.",
            "conclusion": "Hold at building=2 is actually MORE profitable without VB because the per-second cost of waiting is lower."
          },
          "current_apl_error": "The current APL does NOT hold Meta at building=2. It fires at <2 stacks. The root theory that 'building>=2 over-penalizes non-VB builds' is WRONG. The math shows it's even MORE profitable for non-VB builds. The current APL at <2 is suboptimal for ALL builds.",
          "recommended_change": "Change condition to buff.voidfall_building.stack<2 -> remove the stack restriction entirely, OR add buff.voidfall_building.stack>=2 as an explicit hold condition"
        }
      }
    },

    "feldev_channel_during_meta": {
      "channel_time_s": 2.0,
      "meta_gcds_lost": 1.6,
      "meta_gcds_total_base": 12,
      "meta_gcds_total_vb": 16,
      "pct_meta_lost_base": 13.3,
      "pct_meta_lost_vb": 10.0,

      "feldev_total_damage_ap": {
        "base": 1.54,
        "with_stoke": "1.54 * 1.3 = 2.0",
        "with_meta_amp": "2.0 * 1.2 = 2.4",
        "with_fd_amp": "2.4 * 1.15 = 2.76 (if Brand active)",
        "with_meteoric_rise_frags": "3 frags generated -> feeds SBomb at 0.4*3 = 1.2 AP additional"
      },

      "lost_fracture_damage_ap": {
        "two_fractures_meta": "2 * 1.035 * 1.2 = 2.484 AP",
        "two_fractures_meta_vb": "2 * 1.035 * 1.2 * 1.2 = 2.98 AP",
        "plus_fragment_value": "2 Fractures = 6 frags. 5 into SBomb = 0.4*5 = 2.0 AP of SBomb damage"
      },

      "net_during_meta": {
        "feldev_with_stoke_in_meta": 2.4,
        "lost_fractures_in_meta": 2.484,
        "delta_without_fd": "-0.08 AP (FelDev slightly loses to Fracture spam in raw terms)",
        "with_meteoric_rise_3_frags": "+1.2 AP -> net +1.12 AP positive",
        "with_4pc_proc": "+0.5 AP estimated from Fracture 4pc procs forgone",
        "conclusion": "FelDev during Meta with Meteoric Rise is net positive (+1.12 AP). Without Meteoric Rise it's approximately break-even. Current APL correctly allows FelDev during Meta except during Voidfall spending."
      }
    }
  },

  "theory_validation": {
    "theory_1_meta_hold_building_2": {
      "root_theory": "Anni Meta hold at building>=2 over-penalizes non-Vengeful Beast builds because shorter Meta without VB makes double-burst less valuable",
      "verdict": "REFUTED",
      "reasoning": "The cost-per-second of holding Meta is LOWER without VB (0.24 AP/s vs 0.528 AP/s), making the hold MORE profitable, not less. The double-burst gain of 8.1 AP is identical regardless of VB. Break-even hold time is 33.8s without VB vs 15.3s with VB. The current APL's building<2 condition is suboptimal for ALL builds.",
      "actual_finding": "The current APL fires Meta too EARLY (at 0-1 building stacks). It should hold Meta when building>=2 to capture double Voidfall burst. The hold is profitable for both VB and non-VB builds, but especially non-VB.",
      "recommended_test": "Change Meta condition to include building>=2 hold: metamorphosis,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&(buff.voidfall_building.stack<2|buff.voidfall_building.stack>=2&!prev_gcd.1.fracture)",
      "confidence": 0.75,
      "caveat": "This analysis assumes the Voidfall proc chance (35%) allows completing building stacks in reasonable time. Variance could make worst-case holds painful. Simulation needed to confirm."
    },

    "theory_2_ar_brand_aoe_reorder": {
      "root_theory": "AR brand window lacks AoE-aware priority reordering -- Charred Flesh IA should precede Soul Carver at 3+ targets",
      "verdict": "PARTIALLY SUPPORTED",
      "reasoning": {
        "charred_flesh_value": "Each IA tick extends Brand by 0.25s. At 6 ticks over 6s, that's 1.5s added Brand duration per IA cast. More Brand uptime = more FD window for all subsequent casts.",
        "current_apl_brand_window": "IA (if charred_flesh & !IA up) -> Soul Carver -> Spite -> FelDev -> IA (if !charred_flesh). Charred Flesh IA is already FIRST before SC.",
        "aoe_consideration": "At 3+ targets, IA is even more valuable because Fallout generates frags AND Charred Flesh extends Brand. But the current APL already handles this correctly.",
        "actual_gap": "The brand window sub-list has no AoE-specific reordering because the ST ordering already puts IA first for Charred Flesh builds."
      },
      "conclusion": "The current APL already sequences IA before SC in Brand windows when Charred Flesh is talented. No change needed for the basic ordering. The gap is more subtle: in AoE, the brand window doesn't call SBomb between SC and Spite to consume the generated frags before they cap.",
      "actual_hypothesis": "Add SBomb,if=soul_fragments>=3 between Soul Carver and Sigil of Spite in ar_brand_window to prevent fragment overcap during AoE Brand windows",
      "confidence": 0.5
    },

    "theory_3_anni_fd_sbomb_threshold": {
      "root_theory": "Anni lacks FD-aware SBomb threshold -- needs spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active like AR",
      "verdict": "SUPPORTED",
      "reasoning": {
        "ar_has_fd_sbomb": "Line 61: spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active. AR casts SBomb at 3 frags during FD windows.",
        "anni_lacks_fd_sbomb": "Anni main list (lines 128-134) has no FD-aware SBomb threshold. SBomb only fires at spb_threshold (5 or 4 in Meta).",
        "damage_analysis_sbomb_at_3_frags_under_fd": {
          "base_damage": "0.4 AP per frag * 3 frags = 1.2 AP",
          "fd_amp": "1.2 * 1.15 = 1.38 AP",
          "opportunity_cost": "Waiting for 5 frags: 0.4 * 5 = 2.0 AP base, but costs 2+ extra GCDs of Fracture",
          "per_gcd_at_3_under_fd": "1.38 AP / 1 GCD = 1.38 DPGCD",
          "per_gcd_at_5_normal": "2.0 AP / 1 GCD (SBomb) + 2 GCDs (Fracture to build) = 2.0 / 3 = 0.67 DPGCD amortized",
          "per_gcd_at_5_under_fd": "2.0 * 1.15 / 1 GCD + 2 GCDs = 2.3 / 3 = 0.77 DPGCD amortized",
          "conclusion": "SBomb at 3 frags under FD (1.38 DPGCD) beats waiting for 5 frags (0.67-0.77 DPGCD amortized). The amortized cost of additional Fracture GCDs makes the higher threshold strictly worse during FD."
        },
        "anni_specific_considerations": {
          "voidfall_interaction": "SBomb at 3 frags during FD spending still triggers Voidfall meteor consumption. No conflict.",
          "meteoric_fall_interaction": "Meteoric Fall only triggers at 3 Voidfall spending stacks. SC-triggered meteors don't interfere.",
          "othwerorldly_focus": "Otherworldly Focus gives SBomb +35% ST damage at 1 target. At 3 frags under FD in ST: 1.2 * 1.35 * 1.15 = 1.86 AP. Even stronger argument for 3-frag threshold."
        }
      },
      "recommended_change": "Add to anni main list before spb_threshold SBomb: spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active",
      "confidence": 0.8,
      "priority": 8
    }
  },

  "theories": [
    {
      "title": "Fragment overcap is the primary DPS leak, not fury management",
      "reasoning": "Fury generation (~987/min) exceeds consumption (~443/min) by 2.2x. Fragments generate at 73/min ST but only 18/min can be consumed due to SBomb 25s CD and SC 2-frag cap. The 55 frags/min waste represents lost SBomb scaling. No APL change can fix this -- it's a mechanical constraint of the fragment cap (6) vs generation rate. The optimization surface is entirely about WHEN to consume, not WHETHER.",
      "category": "resource_flow",
      "confidence": 0.95,
      "evidence": [
        "Fracture generates 2 frags on 4.17s recharge (28.8 casts/min * 2 = 57.6 frags/min)",
        "SBomb consumes max 5 frags on 25s CD (12/min max consumption)",
        "Soul Cleave consumes max 2 frags with no CD (~6/min in practice)",
        "Total consumption 18/min vs generation 73/min = 75% waste rate",
        "Fragment cap is 6 (MAX_SOUL_FRAGMENTS constant in cpp-proc-mechanics.json)"
      ]
    },
    {
      "title": "Anni Meta fires too early -- building<2 condition wastes double Voidfall burst",
      "reasoning": "Current APL fires Meta at building 0-1 stacks. At building=2, one Fracture proc (35% per cast, ~2.86 casts average) completes the natural spending cycle, then Mass Acceleration grants an immediate 3 stacks for a second burst. This double burst is worth 8.1 AP (3 meteors + World Killer). The hold cost is 0.24-0.528 AP/s depending on VB. Average hold of 3.57s costs 0.86-1.89 AP. Net gain: +6.2 to +7.2 AP. Break-even is 15-34s. The root theory that non-VB builds are penalized is refuted -- they benefit MORE from the hold.",
      "category": "cooldown_alignment",
      "confidence": 0.75,
      "evidence": [
        "Mass Acceleration grants 3 Voidfall stacks on Meta activation",
        "Voidfall proc rate 35% per Fracture (cpp-proc-mechanics.json line 84-86)",
        "VB Meta cost 0.528 AP/s vs non-VB 0.24 AP/s",
        "Double burst value 8.1 AP (3 meteors at 1.5 AP + World Killer +50%)",
        "Expected hold duration 3.57s = 2.86 Fractures at 1.25s GCD"
      ]
    },
    {
      "title": "Anni missing FD-aware SBomb threshold identical to AR",
      "reasoning": "AR has spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active but Anni does not. SBomb at 3 frags under FD gives 1.38 DPGCD (1.2 AP * 1.15 FD). Waiting for 5 frags costs 2 extra Fracture GCDs: amortized DPGCD drops to 0.77. With Otherworldly Focus (+35% ST), the 3-frag FD SBomb reaches 1.86 AP. The Anni Voidfall sub-list partially compensates (FelDev at spending=3 when frag-starved) but the main rotation path has no FD-aware threshold.",
      "category": "talent_interaction",
      "confidence": 0.80,
      "evidence": [
        "AR line 61: spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active",
        "Anni lines 128-134: no FD-aware SBomb condition",
        "SBomb apCoeff 0.4 per frag (SPEC_CONFIG domainOverrides)",
        "FD amp 15% per rank, max 2 ranks = 30% (interactions-summary.json)",
        "Otherworldly Focus +35% ST to SBomb (interactions-summary line 12990)"
      ]
    },
    {
      "title": "Throw Glaive is a deceptive fury drain masquerading as a filler",
      "reasoning": "TG costs 25 fury per cast with a 9s CD (6.67 casts/min potential). At full usage, TG consumes 167 fury/min -- 38% of total fury consumption. This makes it the single largest fury consumer, ahead of SBomb (96/min) and FelDev (75/min). In AR builds, Reaver's Glaive replaces some TG casts and generates 20 fury instead of costing 25, a 45 fury swing per replacement. The fury economy is fundamentally different between AR and Anni due to this asymmetry.",
      "category": "resource_flow",
      "confidence": 0.85,
      "evidence": [
        "TG spell data: 25 Fury cost, 9s CD (spells-summary.json id 185123)",
        "Keen Engagement: Reaver's Glaive generates 20 Fury (spells-summary.json id 442497)",
        "Per-minute TG fury drain: 25 * 6.67 = 167 fury/min at full usage",
        "SBomb fury drain: 40 * 2.4 = 96 fury/min",
        "FelDev fury drain: 50 * 1.5 = 75 fury/min"
      ]
    },
    {
      "title": "Brand window holding for fire CDs: the <6 condition is at theoretical break-even but practically fine",
      "reasoning": "The AR cooldowns Brand condition waits up to 6s for SC/FelDev/Spite. SC in Brand window gains 0.312 AP (2.08 * 0.15). But 6s of hold costs 0.72 AP of lost FD uptime. At 6s hold, net is -0.41 AP. Break-even is ~3s. However, the APL's charge-based logic (charges>=2 || !dot.fiery_brand.ticking) means the hold is typically 0-3s because Brand accumulates charges. The long hold only occurs when Brand was recently used. In practice the condition is fine because of the charge gating.",
      "category": "cooldown_alignment",
      "confidence": 0.65,
      "evidence": [
        "Brand FD window value: 8.0 AP fire damage * 0.15 = 1.2 AP per window",
        "SC gain from Brand: 2.08 * 0.15 = 0.312 AP",
        "Hold cost at 6s: 1.2 * 6/10 = 0.72 AP",
        "Down in Flames: Brand has 2 charges and 48s CD",
        "APL condition uses charges>=2 as primary trigger"
      ]
    },
    {
      "title": "FelDev channel during Meta is net positive with Meteoric Rise but net zero without",
      "reasoning": "2s FelDev channel costs 1.6 Meta GCDs. Lost Fractures = 2 * 1.035 * 1.2 = 2.484 AP. FelDev with Stoke = 2.0 AP in Meta = 2.4 AP. Raw delta: -0.08 AP. But Meteoric Rise generates 3 soul fragments from completed FelDev channel, worth ~1.2 AP when fed into SBomb. Net with MR: +1.12 AP. The current APL allows FelDev during Meta in both AR and Anni (correctly gated to avoid Voidfall spending and AR empowered cycle interruption).",
      "category": "cooldown_alignment",
      "confidence": 0.70,
      "evidence": [
        "FelDev apCoeff 1.54 (SPEC_CONFIG domainOverrides)",
        "Stoke the Flames +30% (interactions-summary)",
        "Meteoric Rise: FelDev generates 3 Soul Fragments (spells-summary id 1253377)",
        "Fracture apCoeff 1.035 (SPEC_CONFIG domainOverrides)",
        "Meta +20% damage (burstWindows in SPEC_CONFIG)"
      ]
    }
  ],

  "hypotheses": [
    {
      "summary": "Add FD-aware SBomb threshold to Anni main rotation (3 frags during Fiery Demise)",
      "implementation": "Insert spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active before the existing spb_threshold SBomb in the anni action list (between lines 128-129)",
      "category": "talent_interaction",
      "priority": 8.0,
      "archetype": null,
      "predicted_impact": "+0.2-0.5% DPS for Anni builds with Fiery Demise talented. Zero impact on non-FD builds.",
      "aplMutation": {
        "op": "insert_before",
        "target": "anni",
        "anchor": "spirit_bomb,if=soul_fragments>=variable.spb_threshold",
        "line": "spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active",
        "comment": "FD fire amp makes 3-frag SBomb casts worthwhile (mirrors AR line 61)"
      }
    },
    {
      "summary": "Test Anni Meta hold at building>=2 for double Voidfall burst",
      "implementation": "Change Meta condition in anni list from building.stack<2 to building.stack<=1 OR add explicit hold: metamorphosis,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&(buff.voidfall_building.stack<=1|!buff.voidfall_building.up)",
      "category": "cooldown_alignment",
      "priority": 7.5,
      "archetype": null,
      "predicted_impact": "+0.3-0.8% DPS for Anni builds. Larger for non-VB builds (lower hold cost). Expected hold is 3.6s average.",
      "risk": "Variance in Voidfall proc rate (35%) could cause outlier holds of 8-10s. Need to confirm via simulation that worst-case doesn't offset average gains.",
      "aplMutation": {
        "op": "modify",
        "target": "anni",
        "current": "metamorphosis,use_off_gcd=1,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&buff.voidfall_building.stack<2",
        "proposed": "metamorphosis,use_off_gcd=1,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&!buff.voidfall_building.up",
        "comment": "Hold Meta when building stacks exist -- wait for natural cycle completion then Mass Acceleration grants double burst"
      }
    },
    {
      "summary": "Add SBomb between Soul Carver and Sigil of Spite in AR Brand window for fragment overcap prevention",
      "implementation": "Insert spirit_bomb,if=soul_fragments>=4 after soul_carver in ar_brand_window. SC generates 3 frags immediately + 3 over 3s. If pool was 1+, frags will cap without immediate consumption.",
      "category": "resource_flow",
      "priority": 5.5,
      "archetype": null,
      "predicted_impact": "+0.05-0.15% DPS. Prevents 2-3 fragment waste per Brand window in AoE scenarios.",
      "aplMutation": {
        "op": "insert_after",
        "target": "ar_brand_window",
        "anchor": "soul_carver",
        "line": "spirit_bomb,if=soul_fragments>=4",
        "comment": "Consume SC-generated frags before Spite dumps more into a nearly-full pool"
      }
    },
    {
      "summary": "Investigate removing or reducing Throw Glaive usage as filler for Anni builds (fury preservation)",
      "implementation": "Add fury condition to TG filler: throw_glaive,if=fury>=80 to prevent TG from draining fury below spender thresholds. Or drop TG priority below Felblade in filler list.",
      "category": "resource_flow",
      "priority": 4.0,
      "archetype": "anni",
      "predicted_impact": "Uncertain. TG costs 167 fury/min at full usage. Restricting to fury>=80 would save ~60 fury/min for spender alignment. But TG also has damage value and AR benefits from Keen Edge (+10%).",
      "risk": "TG damage per GCD may justify its fury cost. Need to compare TG DPGCD vs fury opportunity cost. AR builds should NOT have this restriction due to Reaver's Glaive generating fury.",
      "aplMutation": {
        "op": "modify",
        "target": "fillers",
        "current": "throw_glaive",
        "proposed": "throw_glaive,if=fury>=80|hero_tree.aldrachi_reaver"
      }
    },
    {
      "summary": "Test removing the building<2 condition entirely -- Meta fires only when no building stacks present",
      "implementation": "More aggressive variant of hypothesis 2. Meta only fires when building=0 and not spending, allowing any active building to complete first.",
      "category": "cooldown_alignment",
      "priority": 6.5,
      "archetype": "anni",
      "predicted_impact": "Stronger version of building hold. At building=1, expected ~5.7 Fractures (7.1s) to complete. At building=2, ~2.86 Fractures (3.6s). Average wait considering random entry: ~5.3s. Gain remains 8.1 AP. Cost at 5.3s with VB: 2.8 AP. Net: +5.3 AP.",
      "risk": "At building=1, wait can be 10-15s in worst case (unlucky 35% proc). This may lose more on the tail than the average gains. Simulation is essential.",
      "aplMutation": {
        "op": "modify",
        "target": "anni",
        "current": "metamorphosis,use_off_gcd=1,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&buff.voidfall_building.stack<2",
        "proposed": "metamorphosis,use_off_gcd=1,if=(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&!buff.voidfall_building.up"
      }
    }
  ]
}
