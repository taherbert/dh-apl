# Persistence Schemas

## build-theory.json (data/)

Curated mechanical knowledge about talent clusters, hero tree interactions, and build archetypes. Not auto-generated — edited by hand when analysis reveals new structural insights. Loaded by `src/analyze/archetypes.js`.

Schema: `build-theory-v1`

### Top-level structure

```json
{
  "_schema": "build-theory-v1",
  "_curated": true,
  "_lastUpdated": "2026-02-04",
  "specClusters": [...],
  "heroTrees": {...},
  "clusterSynergies": [...],
  "buildArchetypes": [...],
  "tensionPoints": [...]
}
```

- **specClusters** — Groups of spec talents that mechanically reinforce each other (e.g., fire-brand, fragment-heavy, frailty-amp). Each has id, name, talents, coreLoop, keyMechanics, role.
- **heroTrees** — Keyed by `aldrachi_reaver` / `annihilator`. Each has subtree ID, damage school, core loop, key mechanics, APL branch, choice nodes.
- **clusterSynergies** — 14 entries (7 clusters × 2 hero trees). Each rates how well a spec cluster works with a hero tree (core/strong/moderate/neutral/weak) with reasoning.
- **buildArchetypes** — 6 theoretical builds that emerge from cluster + hero tree combinations. Each has id, name, heroTree, clusters, coreLoop, keyTalents, keyBuffs, keyAbilities, strengths, tensions, tradeoffs, aplFocus.
- **tensionPoints** — Structural conflicts in the build/rotation design that create non-obvious tradeoffs.

## builds.json (results/)

Discovered archetypes and ranked talent builds from the automated discovery pipeline (`npm run discover`). Generated by `src/discover/build-discovery.js`.

### Top-level structure

```json
{
  "_schema": "builds-v1",
  "_generated": "2026-02-04T...",
  "apl": { "file": "apls/vengeance/vengeance.simc", "hash": "abc123" },
  "fidelity": "quick|standard|confirm",
  "scenarios": {
    "st": { "targets": 1, "duration": 300 },
    "small_aoe": { "targets": 5, "duration": 75 },
    "big_aoe": { "targets": 10, "duration": 60 }
  },
  "weights": { "st": 0.5, "small_aoe": 0.3, "big_aoe": 0.2 },
  "factorImpacts": [...],
  "synergyPairs": [...],
  "discoveredArchetypes": [...],
  "allBuilds": [...]
}
```

### factorImpacts entry

Main effect of each DoE factor (talent) on weighted DPS.

```json
{
  "talent": "Down in Flames",
  "nodeId": 90961,
  "factorType": "binary",
  "mainEffect": 1523,
  "pct": 2.1
}
```

### synergyPairs entry

2-factor interaction effects (talents worth more together than separately).

```json
{
  "talents": ["Down in Flames", "Fiery Demise"],
  "nodeIds": [90961, 90982],
  "interaction": 423,
  "pct": 0.6
}
```

### archetypes entry

Discovered archetype — a group of builds sharing the same archetype-forming talent settings.

```json
{
  "name": "Down in Flames + Soul Carver + Fiery Demise",
  "heroTree": "aldrachi_reaver",
  "definingTalents": ["Down in Flames", "Soul Carver", "Fiery Demise"],
  "bestBuild": {
    "hash": "CUkAAAA...",
    "name": "AldrachiReaver_d0_default",
    "dps": { "st": 31555, "small_aoe": 101451, "big_aoe": 179395 },
    "weighted": 65123,
    "talents": {
      "spec": ["Fracture", "Spirit Bomb", "Fiery Demise", "..."],
      "specDifferences": ["+Down in Flames", "-Last Resort"]
    }
  },
  "alternateBuilds": [...],
  "buildCount": 42
}
```

### allBuilds entry

Every build tested, ranked by weighted DPS.

```json
{
  "name": "AldrachiReaver_d0_default",
  "hash": "CUkAAAA...",
  "heroTree": "aldrachi_reaver",
  "dps": { "st": 31555, "small_aoe": 101451, "big_aoe": 179395 },
  "weighted": 65123,
  "rank": 1,
  "pinned": false
}
```

### Operations

**Re-run after APL changes:** `npm run discover -- --quick` to re-rank builds under new APL.

**Confirm rankings:** `npm run discover -- --confirm` for high-fidelity results.

**Filter to one hero tree:** `npm run discover -- --ar-only` or `--anni-only`.

## findings.json

Accumulated analytical insights across sessions. Each finding is a discrete insight with evidence and confidence.

### Finding entry

```json
{
  "date": "2026-02-03",
  "insight": "Short description of the finding",
  "evidence": "Specific numbers, sim results, or reasoning",
  "confidence": "high|medium|low",
  "build": "build-id or archetype name",
  "aplVersion": "filename or hash",
  "status": "validated|rejected|untested|superseded",
  "tags": ["category-tags", "for-filtering"],
  "supersededBy": null
}
```

### Operations

**On session startup:**

1. Read findings, filter to `status: "validated"` for current context
2. Use as calibration: "we already know X, so hypothesis Y should account for it"

**On session completion:**

1. Append new findings for each insight discovered
2. If a finding contradicts an existing one, mark the old one `superseded`

### Tags (common)

- `fragment-economy` — fragment generation, consumption, overflow
- `fury-economy` — fury generation, spending, overcap
- `resource-gating` — guards that restrict ability usage
- `resource-competition` — consumers competing for same pool
- `cooldown-sequencing` — order of cooldown usage
- `burst-window` — damage amplification window utilization
- `fiery-demise` — Fiery Brand window optimization
- `metamorphosis` — Meta window optimization
- `state-machine` — AR cycle or Anni Voidfall cycle
- `talent-synergy` — talent interaction compound effects
- `build-apl-coupling` — changes that require both build and APL adaptation
- `target-count` — AoE scaling, breakpoints
