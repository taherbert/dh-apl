{
  "_schema": "magic-numbers-analysis-v1",
  "_generatedAt": "2026-02-06",
  "_doc": "Deep analysis of APL magic numbers and fragment lookahead system design. Each magic number is traced to its mechanical root with proposed derived expressions.",

  "magicNumbers": [
    {
      "location": "Line 18, variable spb_threshold UR fishing override: buff.metamorphosis.remains<8",
      "currentValue": "8",
      "mechanic": "Seconds remaining on Metamorphosis before it drops. The APL lowers the Spirit Bomb fragment threshold from 5 to 4 when Meta is about to expire, to squeeze in more SBomb casts for Untethered Rage proc attempts.",
      "derivation": "Meta duration is 15s base (20s with Vengeful Beast). At typical haste (~15-20%), GCD is ~1.3s, so 8s = ~6 GCDs. In 6 GCDs you can fit ~2 Fractures (4-6 frags) + 1-2 SBomb casts + filler. UR proc formula: souls_consumed * 0.0075 * pow(1.35, seething_anger_up). At 4 frags: 3.0% base, 4.05% with seething anger. At 5 frags: 3.75% / 5.06%. With 2 SBomb attempts at 4 frags each, cumulative proc ≈ 1 - (1-0.03)^2 = 5.9% (or 7.9% with seething anger). The 8s threshold represents 'enough GCDs for 2 meaningful SBomb casts' — any less and you can only fit 1 cast, halving proc chance. The value 8 is approximately 6 GCDs × base_gcd/haste ≈ 6 × 1.3s = 7.8s, rounded up to 8.",
      "proposedReplacement": "buff.metamorphosis.remains<(6*gcd.max)",
      "expressionMeaning": "6 GCDs remaining — enough for 2 Fracture + 2 SBomb casts. Uses gcd.max which dynamically adjusts for haste.",
      "confidence": "high",
      "notes": "gcd.max is a valid SimC expression that returns the GCD duration accounting for haste. At 0% haste gcd.max=1.5, at 15% it's 1.3, at 30% it's 1.15. The expression 6*gcd.max evaluates to 9.0s at 0% haste, 7.8s at 15%, 6.9s at 30%. This scales correctly with gear progression: more haste = more GCDs fit in less time, so the window shrinks."
    },
    {
      "location": "Line 20, variable ur_fishing: buff.metamorphosis.remains<8",
      "currentValue": "8",
      "mechanic": "Same threshold as spb_threshold override — defines when UR fishing mode activates. Identical derivation.",
      "derivation": "Same as above: 6 GCDs of UR fishing opportunity.",
      "proposedReplacement": "buff.metamorphosis.remains<(6*gcd.max)",
      "expressionMeaning": "Must match spb_threshold override threshold for consistency.",
      "confidence": "high",
      "notes": "These two thresholds MUST stay synchronized. If one changes, the other must too."
    },
    {
      "location": "Line 16, variable spb_threshold base: value=5",
      "currentValue": "5",
      "mechanic": "Default fragment threshold for Spirit Bomb casts. Spirit Bomb consumes up to 5 fragments, each adding +20% damage to the base hit. A 5-fragment cast deals 2.0x the base, vs 0.8x at 4 fragments (each frag is +20% of base, so 5×0.2=1.0 bonus → 2.0x total, 4×0.2=0.8 → 1.8x total).",
      "derivation": "Spirit Bomb damage = base × (1 + fragments × 0.2). At 5 frags: base × 2.0. At 4 frags: base × 1.8. The per-fragment value at 5 is base×0.2 = 10% of max-frag cast. Waiting for the 5th fragment costs 1 GCD (Fracture) worth ~0.5s, but gains ~11% more SBomb damage. Empirically confirmed: +0.21% weighted DPS over threshold=4 (ST +0.36%, 10T +0.44%). The cap of 5 comes from Spirit Bomb's hard-coded 'consume up to 5' mechanic (spell 247454).",
      "proposedReplacement": "5 (keep as literal — this is the mechanical cap of Spirit Bomb consumption, not a tuning knob)",
      "expressionMeaning": "Fragment cap consumed by Spirit Bomb is always 5, regardless of gear/talents.",
      "confidence": "high",
      "notes": "This is a game-mechanic constant, not a haste/gear-dependent value. No dynamic expression needed. The value equals Spirit Bomb's maximum fragment consumption count."
    },
    {
      "location": "Line 18, spb_threshold UR fishing override: value=4",
      "currentValue": "4",
      "mechanic": "Lowered SBomb threshold during UR fishing. Casting SBomb at 4 frags instead of 5 means more SBomb casts per time window, which means more UR proc attempts. The tradeoff: 4-frag SBomb deals ~10% less damage than 5-frag, but the extra cast attempt at UR proc outweighs the DPS loss during the fishing window.",
      "derivation": "UR proc formula: souls_consumed × 0.0075 × pow(1.35, seething_anger_up). At 4 frags: 3.0% (4.05% SA). At 5 frags: 3.75% (5.06% SA). Two 4-frag casts give cumulative 5.9% (7.9% SA). One 5-frag cast gives only 3.75% (5.06% SA). Extra cast attempt = +58% cumulative proc chance, worth far more than the ~10% per-cast damage loss. The value 4 = 'minimum fragments where SBomb is still worth casting' since at 3 frags the proc chance drops to 2.25% and the damage penalty is -25%.",
      "proposedReplacement": "4 (keep as literal — represents minimum viable SBomb fragment count for UR fishing)",
      "expressionMeaning": "Casting with fewer than 4 fragments makes the damage cost too high relative to the marginal proc chance gained.",
      "confidence": "high",
      "notes": "Could theoretically use 3 during seething anger (cumulative chance of three 3-frag casts with SA: 1-(1-0.030375)^3 = 8.9%), but the damage loss at 3 frags (-25%) makes it suboptimal except in extreme fishing scenarios. The UR fishing sub-list already handles the seething_anger case with a separate threshold=3 line (line 122)."
    },
    {
      "location": "Line 22, variable fallout_aoe: active_enemies>=3",
      "currentValue": "3",
      "mechanic": "Target count threshold for Fallout AoE mode. Fallout gives Immolation Aura ticks a 60% chance per target to shatter a Lesser Soul Fragment (100% chance at 1 target). At 3 targets, expected fragments per tick = 3 × 0.6 = 1.8. Over a 6-tick ImmAura, that's ~10.8 fragments — saturating the fragment cap and making ImmAura the dominant fragment generator.",
      "derivation": "ImmAura ticks once per second for 6 ticks. Fallout proc chance: 100% at 1 target (SimC hardcoded), 60% per target at 2+ targets. Fragment rate: 1T=1.0/tick, 2T=1.2/tick, 3T=1.8/tick, 4T=2.4/tick. Fragment cap is 6. At 3 targets, one ImmAura generates ~10.8 fragments total — nearly double the cap. This means ImmAura becomes the primary generator, and Fracture can be deprioritized. The breakpoint is where ImmAura fragment rate exceeds Fracture's: Fracture generates 2/GCD (1.3s) = 1.54/s. ImmAura at 3T generates 1.8/s passively. At 3 targets, ImmAura matches Fracture's rate without consuming GCDs.",
      "proposedReplacement": "3 (keep as literal — this is a structural breakpoint, not gear-dependent)",
      "expressionMeaning": "The crossover point where passive ImmAura fragment generation exceeds active Fracture generation rate.",
      "confidence": "high",
      "notes": "This breakpoint doesn't shift with haste because both ImmAura tick rate and GCD scale identically with haste. The ratio stays constant. The value 3 is mechanically derived from Fallout's 60% proc rate."
    },
    {
      "location": "Lines 37-38, 133-134: cooldown.metamorphosis.remains<10 (trinket sync)",
      "currentValue": "10",
      "mechanic": "Threshold for buffed trinket sync with Metamorphosis. If Meta comes off CD within 10 seconds, hold the buffed trinket to align with Meta. Otherwise use the trinket immediately to avoid waste from holding too long.",
      "derivation": "Most buff trinkets have 15-20s buff duration and 90-120s cooldown. If Meta is 10s away and the trinket buff lasts 15-20s, you still get 5-10s of buff+Meta overlap. Holding longer than ~10s means losing a full trinket use over the fight (if trinket CD is 90s, losing 10s = ~11% of a use; losing 20s = ~22%). The value 10 represents the maximum hold time where the expected Meta overlap benefit exceeds the DPS cost of delayed trinket uses.",
      "proposedReplacement": "10 (keep as literal — this is a standard SimC trinket sync heuristic used across all specs)",
      "expressionMeaning": "Standard trinket-to-cooldown sync window. The exact optimal value depends on fight length and trinket duration, but 10s is a robust default.",
      "confidence": "medium",
      "notes": "The true optimal hold time depends on: trinket buff duration, trinket cooldown, remaining fight time, and Meta's damage amp. A more precise expression would be 'cooldown.metamorphosis.remains<trinket.1.buff_duration*0.5' but this requires knowing the specific trinket buff duration, which varies. 10s is a conservative universal approximation that works well across trinket types."
    },
    {
      "location": "Line 56, AR fracture charge management: cooldown.fracture.charges>=2",
      "currentValue": "2",
      "mechanic": "Fracture has 2 charges with a recharge CD. Using a charge when at 2 (max) means the recharge timer is paused. This line ensures Fracture is cast when charge-capped to keep the recharge timer running. The condition charges>=2 means 'at max charges — a charge is being wasted via paused recharge timer.'",
      "derivation": "Fracture base has charges: { count: 2, cooldown: 4.5s (with Perfectly Balanced Glaive, base 6s minus 1s) }. When at 2/2 charges, the internal recharge timer stops. Every second spent at 2/2 is a lost fraction of a charge. This is standard charge management: never sit at max charges. The value 2 equals the max charge count from the spell data.",
      "proposedReplacement": "cooldown.fracture.charges_fractional>=1.7",
      "expressionMeaning": "Using charges_fractional catches the case where you're about to cap (e.g., 1.7/2 charges, meaning 0.3×4.5s = 1.35s until waste). This is more aggressive than waiting until exactly 2, reducing charge waste by ~0.5s per cycle on average.",
      "confidence": "medium",
      "notes": "The current >=2 is simple and correct. The fractional version is a micro-optimization — it fires Fracture ~1.35s earlier to prevent the last fraction of recharge waste. The DPS difference is likely <0.05%. Keep the current value unless micro-optimization is desired. The reference APL uses charges_fractional>=1 which is far more aggressive."
    },
    {
      "location": "Lines 59: spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active (Fiery Demise SBomb threshold)",
      "currentValue": "3",
      "mechanic": "During Fiery Demise windows, SBomb threshold drops from 5 to 3. Fiery Demise provides +30% fire damage to the branded target (from talent data: 15% base, doubled by Soulcrush). A 3-fragment SBomb during FD: base × 1.6 × 1.3 = base × 2.08 effective. A 5-fragment SBomb outside FD: base × 2.0. So even at 3 frags, FD makes the cast more valuable than a 5-frag non-FD cast.",
      "derivation": "SBomb damage = base × (1 + frags × 0.2). At 3 frags: base × 1.6. With Fiery Demise (+30% fire amp from talent+Soulcrush interaction): 1.6 × 1.30 = 2.08 effective damage. Compare to 5-frag no-FD: 2.0 effective. The breakeven is at 3 frags where FD-amplified damage (2.08) exceeds un-amplified 5-frag (2.0). At 2 frags: 1.4 × 1.30 = 1.82, below 2.0 — not worth it. Threshold of 3 is the exact breakeven point.",
      "proposedReplacement": "3 (keep as literal — exact mechanical breakpoint from Fiery Demise amplification math)",
      "expressionMeaning": "Minimum fragments where FD-amplified SBomb exceeds non-FD 5-fragment SBomb.",
      "confidence": "high",
      "notes": "This was empirically confirmed at +0.18% weighted, +0.30% AR. The math checks out: 3 is the exact breakeven point. At Soulcrush rank 2 the amp may differ slightly, but the threshold remains 3."
    },
    {
      "location": "Lines 89, 115: sigil_of_spite,if=soul_fragments<=5 (fragment overflow guard)",
      "currentValue": "5",
      "mechanic": "Sigil of Spite generates 3 fragments (4 with Broken Spirit). This guard prevents casting SoS when fragments are already near cap (6), which would waste generated fragments to overflow. At soul_fragments<=5, SoS could generate up to soul_fragments+3=8, capped at 6 — max 2 wasted. At <=4, max 1 wasted. At <=3, no waste.",
      "derivation": "Fragment cap = 6 (MAX_SOUL_FRAGMENTS from cpp-proc-mechanics.json). Sigil of Spite generates 3 base + 1 from Broken Spirit (AR hero talent) = 3-4 fragments. Guard at <=5 allows 1 overflow (5+3=8, capped to 6, 2 wasted) but ensures the CD isn't held excessively. Guard at <=3 is 'zero waste' but holds the CD too long, costing DPS from delayed damage and Frailty applications.",
      "proposedReplacement": "soul_fragments<=6-3*!talent.broken_spirit-4*talent.broken_spirit",
      "expressionMeaning": "Allow casting when current + expected generation won't overflow. Broken Spirit adds 1 extra fragment to SoS.",
      "confidence": "medium",
      "notes": "Actually, a simpler expression: soul_fragments<=(6-3-talent.broken_spirit) i.e. soul_fragments<=(3-talent.broken_spirit) would be zero-waste but overly conservative. The current <=5 is a deliberate trade: accept some overflow to avoid holding the cooldown. This is correct for DPS optimization since SoS's direct damage and Frailty application outweigh a few wasted fragments. Keep as-is."
    },
    {
      "location": "Lines 125-126, 185-186: UR fishing fragment generators: soul_fragments<=2 (SoS/Soul Carver guard)",
      "currentValue": "2",
      "mechanic": "During UR fishing, fragment generators (SoS: 3 frags, Soul Carver: 3 frags) are gated to soul_fragments<=2 so generated fragments don't overflow the cap. This ensures fragments go to a 4+ SBomb cast rather than being wasted.",
      "derivation": "Fragment cap = 6. Soul Carver generates 3 instant fragments. At soul_fragments<=2: 2+3=5, no overflow, leaves room for a 5-frag SBomb. At soul_fragments=3: 3+3=6, exactly caps — technically fine but no room for Fracture before SBomb. At soul_fragments=4: 4+3=7, 1 wasted. The threshold <=2 is optimal: it guarantees zero overflow AND produces enough fragments (5) for a max-value SBomb, which gives the highest UR proc chance (5 × 0.0075 = 3.75%).",
      "proposedReplacement": "2 (keep as literal — derived from cap(6) - soul_carver_gen(3) - buffer(1) = 2)",
      "expressionMeaning": "Max current fragments where Soul Carver/SoS generation doesn't overflow AND leaves room for a max-value SBomb.",
      "confidence": "high",
      "notes": "The buffer of 1 accounts for potential Fracture between generator and SBomb. Without the buffer (threshold=3), you'd cap at 6 and any incidental fragment generation (Fallout tick, Soul Sigils) would overflow."
    },
    {
      "location": "Line 150: anni sigil_of_spite,if=soul_fragments<=2+talent.soul_sigils",
      "currentValue": "2+talent.soul_sigils (evaluates to 2 or 3)",
      "mechanic": "Anni version adjusts for Soul Sigils talent, which adds +1 fragment from sigil activation. If Soul Sigils is talented, SoS generates 3 frags (direct) + 1 (Soul Sigils) = 4, so guard loosens to <=3. Without Soul Sigils: 3 frags, guard at <=2.",
      "derivation": "Same overflow logic as AR: cap(6) - sigil_of_spite_gen(3) - soul_sigils_bonus(0 or 1) = 3 or 2. The expression talent.soul_sigils returns 1 if talented, 0 otherwise, making the guard dynamic.",
      "proposedReplacement": "Already uses a dynamic expression — this is well-derived.",
      "expressionMeaning": "Dynamic guard adjusting for Soul Sigils talent.",
      "confidence": "high",
      "notes": "This is an example of good APL design: the threshold adapts to the build. The AR version at <=5 is less precise."
    },
    {
      "location": "Line 151: anni soul_carver,if=soul_fragments<=3",
      "currentValue": "3",
      "mechanic": "Soul Carver generates 3 fragments instantly + 1/sec over 3s (3 more over duration, for up to 6 total). The guard at <=3 prevents the instant 3 from causing immediate overflow (3+3=6, exactly caps). The additional 1/sec fragments over 3s will overflow if fragments aren't consumed, but this is acceptable since their generation is spread over time and concurrent consumption (via SC/SBomb) will absorb them.",
      "derivation": "Fragment cap = 6. Soul Carver instant generation = 3. Guard at <=3: 3+3=6, no instant overflow. The periodic fragments (1/s over 3s) are expected to be consumed by normal rotation during those 3 seconds. Guard at <=2 would be safer but holds the cooldown unnecessarily.",
      "proposedReplacement": "3 (keep as literal — cap(6) minus instant_generation(3) = 3)",
      "expressionMeaning": "Exactly prevents instant overflow from Soul Carver's upfront fragment burst.",
      "confidence": "high",
      "notes": "Slightly less conservative than AR UR fishing (<=2), which is correct since outside UR fishing we don't need to guarantee room for a max-value SBomb immediately after."
    },
    {
      "location": "Line 179: anni_voidfall fracture,if=fury>=70 (Voidfall transition fury pool)",
      "currentValue": "70",
      "mechanic": "Before transitioning from Voidfall building to spending (by casting Fracture at stack=2 to proc the 3rd stack), pool 70 Fury. The spending phase needs 3 Soul Cleaves to dump all 3 stacks. Soul Cleave costs 35 Fury each = 105 Fury total for all 3. Two upfront Soul Cleaves = 70 Fury, then natural generation (Fracture charges, ImmAura ticks, filler) covers the 3rd's 35 Fury cost over the ~3-4s window.",
      "derivation": "Voidfall spending phase: need 3 Soul Cleave casts at 35 Fury each = 105 total. Fury generation during spending: ~2 GCDs of filler between SC casts (Fracture=25-40 Fury, ImmAura ticks ~3/s = 6-9 Fury over 2-3s). Expected gen during spending ≈ 25-40 (one Fracture) + 6-9 (ImmAura) = 31-49. So need 105 - 35 = 70 Fury to cast first 2 SCs immediately, then gen covers the 3rd. The value 70 = 2 × soul_cleave_cost(35).",
      "proposedReplacement": "fury>=(2*action.soul_cleave.cost)",
      "expressionMeaning": "Pool enough for 2 Soul Cleaves upfront; natural generation covers the 3rd.",
      "confidence": "high",
      "notes": "action.soul_cleave.cost is a valid SimC expression returning the current Fury cost of Soul Cleave. If any future talent modifies SC cost, this expression adapts automatically. Currently evaluates to 70 (2×35)."
    },
    {
      "location": "Line 122, 183: UR fishing SBomb with seething anger: soul_fragments>=3",
      "currentValue": "3",
      "mechanic": "During UR fishing with Seething Anger buff active, lower SBomb threshold to 3. Seething Anger multiplies UR proc chance by 1.35x (pow(1.35, 1)). At 3 frags + SA: 3 × 0.0075 × 1.35 = 3.04%. The extra cast attempt matters more than waiting for more fragments because SA may expire.",
      "derivation": "UR proc = souls × 0.0075 × 1.35^(SA up). At 3+SA: 3.04%. At 4 no SA: 3.0%. At 4+SA: 4.05%. At 5+SA: 5.06%. Seething Anger is a bad-luck protection buff that stacks after failed proc attempts. Its duration is limited, so you want to maximize attempts while it's active. At 3 frags with SA, the proc chance (3.04%) is already higher than 4 frags without SA (3.0%), making the lower threshold worthwhile.",
      "proposedReplacement": "3 (keep as literal — mechanical breakpoint where SA-boosted 3-frag ≈ non-SA 4-frag)",
      "expressionMeaning": "Minimum fragments where Seething Anger-boosted proc chance meets/exceeds the non-SA 4-frag threshold.",
      "confidence": "high",
      "notes": "The 3-frag SA threshold is a precise derivation: 3 × 0.0075 × 1.35 = 0.030375 vs 4 × 0.0075 = 0.030. They cross at exactly 3 fragments. This is not a tuning knob."
    },
    {
      "location": "Lines 37-38, 133-134: trinket slot conditions use buff.metamorphosis.up|cooldown.metamorphosis.remains<10|cooldown.metamorphosis.remains>trinket.N.cooldown.duration",
      "currentValue": "Pattern with three conditions",
      "mechanic": "Three-clause trinket decision: (1) Meta is active — use now for overlap. (2) Meta is coming soon (<10s) — hold for sync. (3) Meta is so far away the trinket would come off CD again before Meta — use now to avoid wasting a full trinket CD. The third clause prevents over-holding when Meta CD is very long.",
      "derivation": "If Meta CD remaining > trinket CD (typically 90-120s), you'd get another trinket use before Meta anyway, so don't hold. This is standard trinket logic in SimC APLs. The three clauses together cover all cases: use during Meta, hold if Meta is near, use freely if Meta is far.",
      "proposedReplacement": "Pattern is already well-expressed. No changes needed.",
      "expressionMeaning": "Comprehensive trinket-to-Meta alignment heuristic.",
      "confidence": "high",
      "notes": "This pattern is used identically in both AR and Anni branches and in the SimC reference APL."
    },
    {
      "location": "Line 64: reference APL ar sigil_of_spite,if=!buff.reavers_glaive.up&(buff.art_of_the_glaive.stack+soul_fragments.total)<20",
      "currentValue": "20",
      "mechanic": "Art of the Glaive triggers Reaver's Glaive after consuming 20 soul fragments (from spell 442290 description). This guard prevents casting SoS when close to triggering Reaver's Glaive — the fragments generated by SoS would push past the 20-frag threshold, but you want to cast Reaver's Glaive on your terms, not accidentally trigger it mid-rotation.",
      "derivation": "Art of the Glaive requires consuming 20 Soul Fragments OR casting Sigil of Spite to convert Throw Glaive into Reaver's Glaive. The guard (stack+total)<20 ensures you don't accidentally trigger AotG from natural fragment consumption right before you wanted to use SoS for a different purpose.",
      "proposedReplacement": "This is in the REFERENCE APL only (not our APL). Our APL handles this differently via the ar_empowered sub-list which checks buff.reavers_glaive.up directly.",
      "expressionMeaning": "Fragment counter approaching AotG trigger — delay SoS to prevent uncontrolled trigger.",
      "confidence": "high",
      "notes": "Our APL doesn't use this pattern — we use buff-based detection instead. Documented for completeness."
    }
  ],

  "lookaheadSystem": {
    "designPrinciples": [
      "Estimate fragments that will become available within 1-2 GCDs, allowing proactive spending decisions",
      "Use ONLY valid SimC APL expressions — no custom lua or external state",
      "Account for fragment cap (6) to avoid counting overflow as useful",
      "Differentiate between guaranteed fragments (Fracture charges) and probabilistic (Fallout procs, Soul Sigils)",
      "Must be cheap to evaluate — runs every APL cycle"
    ],

    "variables": [
      {
        "name": "frags_from_fracture",
        "aplDefinition": "variable,name=frags_from_fracture,value=(2+buff.metamorphosis.up)*(cooldown.fracture.charges>=1)",
        "purpose": "Fragments available from next Fracture cast: 2 base, 3 in Meta. Zero if no charges available.",
        "accuracy": "Exact for guaranteed generation. Does not account for Soul Splitter 2% bonus proc.",
        "notes": "Fracture generates 2 fragments base, 3 during Meta. buff.metamorphosis.up returns 1 when active, adding the bonus fragment."
      },
      {
        "name": "frags_from_sigils",
        "aplDefinition": "variable,name=frags_from_sigils,value=talent.soul_sigils*(cooldown.sigil_of_flame.ready|cooldown.sigil_of_spite.ready)",
        "purpose": "Fragments from next sigil activation via Soul Sigils talent. Returns 0 if not talented or no sigil ready.",
        "accuracy": "Exact for Soul Sigils generation. Does not account for 2s sigil activation delay (1s with Quickened Sigils).",
        "notes": "Soul Sigils generates 1 fragment per sigil activation. Fragment arrives after sigil detonation delay, NOT instantly — this variable predicts within 2-3 GCDs, not next GCD."
      },
      {
        "name": "frags_from_soul_carver",
        "aplDefinition": "variable,name=frags_from_soul_carver,value=3*(cooldown.soul_carver.ready)+dot.soul_carver.ticking",
        "purpose": "Fragments available from Soul Carver: 3 instant if off CD, or 1 from periodic (already ticking).",
        "accuracy": "Approximate. Soul Carver's periodic generates 1 frag/sec over 3s, but this only predicts whether it's currently ticking (=1) rather than estimating remaining ticks.",
        "notes": "The periodic fragments (1/sec) are hard to model precisely in APL. dot.soul_carver.ticking returning 1 indicates at least 1 more fragment is coming from the DoT."
      },
      {
        "name": "fallout_frags_per_gcd",
        "aplDefinition": "variable,name=fallout_frags_per_gcd,value=talent.fallout*buff.immolation_aura.up*(active_enemies>=2)*(0.6*active_enemies)+(talent.fallout*buff.immolation_aura.up*(active_enemies=1))",
        "purpose": "Expected Fallout fragments per GCD. At 1 target: 1.0/tick (100% proc rate in SimC). At N targets: 0.6*N per tick. ImmAura ticks every 1s and GCD is ~1.3-1.5s, so this slightly underpredicts for a full GCD window.",
        "accuracy": "Expected value per tick, approximately per GCD. Actual fragments are probabilistic — 0, 1, or more per tick at AoE. At 3 targets: E[frags]=1.8, but could be 0-3.",
        "notes": "SimC hardcodes Fallout as 100% at 1 target and 60% per target at 2+. The expression uses active_enemies>=2 to switch between ST (guaranteed 1) and AoE (0.6*N). Since ImmAura ticks once per second and a GCD is ~1.3s, actual per-GCD generation is ~1.3x this value."
      },
      {
        "name": "frags_available_soon",
        "aplDefinition": "variable,name=frags_available_soon,value=soul_fragments+variable.frags_from_fracture",
        "purpose": "Fragments available after a single Fracture cast. The most reliable short-term prediction: current frags + what Fracture would add if cast next GCD.",
        "accuracy": "High accuracy for 1-GCD lookahead when Fracture has charges. Does not include slower sources (sigils, Soul Carver CD).",
        "notes": "This is the primary lookahead variable for SBomb threshold decisions. If frags_available_soon>=5, you can Fracture→SBomb in 2 GCDs."
      },
      {
        "name": "frags_saturated",
        "aplDefinition": "variable,name=frags_saturated,value=soul_fragments>=5|(soul_fragments>=3&variable.fallout_frags_per_gcd>=2)",
        "purpose": "Boolean: are fragments at or near cap? Either we have 5+ already (one SBomb cast away from cap) or we have 3+ with strong Fallout generation (3+ targets with ImmAura) that will push us to cap within 1-2 ticks.",
        "accuracy": "Conservative estimate. Biases toward spending to avoid overflow.",
        "notes": "Used to trigger early SBomb casts when fragment overflow is imminent. At 5 frags, any Fracture or Fallout tick overflows. At 3 frags with 2+ expected Fallout/tick, we'll cap within 2 ticks (~2s)."
      },
      {
        "name": "frags_building_fast",
        "aplDefinition": "variable,name=frags_building_fast,value=buff.metamorphosis.up|(variable.fallout_aoe&buff.immolation_aura.up)|dot.soul_carver.ticking",
        "purpose": "Boolean: are fragments accumulating faster than normal? True during Meta (3/Fracture instead of 2), during Fallout AoE with ImmAura active, or while Soul Carver DoT is ticking (1/sec). When true, spending thresholds can be more aggressive because fragments refill quickly.",
        "accuracy": "Qualitative — indicates high-generation state rather than predicting exact count.",
        "notes": "This is useful as a modifier on spending thresholds. When frags_building_fast is true, a 4-frag SBomb is acceptable because the 5th fragment will arrive before the next SBomb opportunity."
      }
    ],

    "usageExamples": [
      {
        "currentLine": "spirit_bomb,if=soul_fragments>=variable.spb_threshold",
        "proposedLine": "spirit_bomb,if=soul_fragments>=variable.spb_threshold|(soul_fragments>=4&variable.frags_building_fast)",
        "rationale": "When fragments are building fast (Meta, Fallout AoE, Soul Carver ticking), casting at 4 frags is acceptable because the 5th would arrive before the next SBomb opportunity — and sitting at 5 wastes Fallout/Carver procs to overflow. This effectively dynamically adjusts the threshold based on generation rate.",
        "expectedImpact": "Small DPS gain from reduced fragment overflow, most impactful in AoE with Fallout active. Estimated +0.05-0.15% weighted.",
        "risk": "Low — the 4-frag threshold is already proven acceptable during UR fishing."
      },
      {
        "currentLine": "fracture,if=cooldown.fracture.charges>=2&soul_fragments<variable.spb_threshold",
        "proposedLine": "fracture,if=cooldown.fracture.charges>=2&!variable.frags_saturated",
        "rationale": "Replace the fixed spb_threshold guard with the dynamic saturation check. If fragments are saturated (>=5 or high Fallout gen), don't Fracture even at 2 charges — the fragments would overflow. The frags_saturated variable accounts for Fallout generation that the fixed threshold ignores.",
        "expectedImpact": "Prevents fragment overflow during AoE with Fallout. Net effect is marginal in ST but measurable at 3+ targets.",
        "risk": "Low — frags_saturated is conservative and biases toward spending."
      },
      {
        "currentLine": "sigil_of_spite,if=soul_fragments<=5",
        "proposedLine": "sigil_of_spite,if=soul_fragments<=(6-(3+talent.broken_spirit))",
        "rationale": "Dynamic guard accounting for Broken Spirit's extra fragment generation from SoS. Without Broken Spirit (Anni), SoS generates 3 → guard <=3. With Broken Spirit (AR), SoS generates 4 → guard <=2. This prevents overflow more precisely than the static <=5.",
        "expectedImpact": "Reduces fragment overflow from SoS by 1-2 per cast on average. The DPS impact depends on how often SoS is cast near fragment cap.",
        "risk": "Medium — the tighter guard may delay SoS usage in some situations. The current <=5 deliberately accepts overflow. Need to sim to verify the DPS tradeoff."
      },
      {
        "currentLine": "fracture,if=buff.metamorphosis.up (AR Meta Fracture priority)",
        "proposedLine": "fracture,if=buff.metamorphosis.up&soul_fragments<=(6-(2+buff.metamorphosis.up))",
        "rationale": "During Meta, Fracture generates 3 frags instead of 2. At soul_fragments=4, a Meta Fracture produces 4+3=7, overflowing by 1. This guard caps the overflow: only Fracture if current frags + expected gen <= cap. The expression 6-(2+meta_up) evaluates to <=3 during Meta, <=4 outside Meta.",
        "expectedImpact": "Saves 0.5-1 fragment per Meta window from overflow. Very small DPS gain (<0.05%).",
        "risk": "Low, but the guard may delay Fracture when overflow is acceptable (e.g., if SBomb is coming next GCD). The current uncapped Fracture was tested at +10.4% over a guard<=4 — suggesting overflow is acceptable because the GCD efficiency of Meta Fracture outweighs fragment waste."
      }
    ],

    "implementationNotes": {
      "evaluation_order": "Lookahead variables must be defined BEFORE the action lines that reference them. Place them in the default action list, after spb_threshold and before auto_attack.",
      "performance": "Each variable adds one expression evaluation per APL cycle. The proposed 7 variables add negligible overhead — SimC evaluates thousands of expressions per cycle already.",
      "testability": "Enable 'debug=1' in SimC to trace variable values each cycle. Compare fragment waste (soul_fragments.wasted stat) between current and proposed APL.",
      "phasing": "Recommend implementing in phases: (1) frags_from_fracture + frags_available_soon first, (2) fallout variables for AoE, (3) saturation/building_fast for threshold relaxation.",
      "caveat_on_dynamic_thresholds": "The current APL's static threshold=5 was empirically validated at +0.21% over threshold=4. Any dynamic relaxation must be tested against this baseline. The lookahead system's value is primarily in OVERFLOW PREVENTION (not threshold relaxation) — knowing when NOT to generate is as valuable as knowing when to spend."
    }
  },

  "crossCuttingInsights": [
    {
      "insight": "Most magic numbers are mechanically derived, not arbitrary",
      "detail": "Of the 14 magic numbers analyzed, 11 are directly derivable from game mechanics (fragment caps, proc formulas, spell costs, ability generation counts). Only 3 are heuristic approximations (trinket sync 10s, Meta remains 8s, SoS overflow guard 5). The APL is well-constructed."
    },
    {
      "insight": "The UR fishing remains<8 threshold is the best candidate for dynamic expression",
      "detail": "Replacing 8 with 6*gcd.max makes the threshold haste-responsive. At low haste (fresh 80), 6*1.5=9.0s gives slightly more fishing time. At high haste (end-tier), 6*1.15=6.9s tightens appropriately. This is the highest-confidence improvement."
    },
    {
      "insight": "Fragment overflow is the primary waste vector, not suboptimal spending",
      "detail": "The lookahead system's highest value is in predicting and preventing overflow, not in relaxing spending thresholds. Fragment overflow happens when generation outpaces consumption: during Meta (3/Fracture), Fallout AoE (0.6*N/tick), and Soul Carver ticking (1/sec). The frags_saturated and frags_building_fast variables target this directly."
    },
    {
      "insight": "Fury pooling for Voidfall transition is expressible dynamically",
      "detail": "The fury>=70 threshold for Voidfall building→spending transition can be expressed as fury>=(2*action.soul_cleave.cost). This future-proofs against any talent/mechanic that modifies Soul Cleave's Fury cost."
    },
    {
      "insight": "The Anni SoS guard is better-designed than the AR version",
      "detail": "Anni's soul_fragments<=2+talent.soul_sigils dynamically adjusts for talent selection. The AR version uses static <=5 which is overly permissive. Consider harmonizing AR to use the same pattern: soul_fragments<=(6-3-talent.broken_spirit) or similar."
    }
  ]
}
