{
  "callHierarchyAnalysis": {
    "currentStructure": {
      "default": [
        "variable definitions (fiery_demise_active, spb_threshold, ur_fishing, fallout_aoe)",
        "auto_attack",
        "disrupt",
        "infernal_strike (off-GCD)",
        "demon_spikes (off-GCD)",
        "run_action_list,name=ar  (hero_tree.aldrachi_reaver)",
        "run_action_list,name=anni (hero_tree.annihilator)"
      ],
      "ar": [
        "trinkets (3 lines: trinket1, trinket2, tome)",
        "potion (empowered window)",
        "call externals (empowered window)",
        "metamorphosis (off-GCD: if not up OR untethered_rage proc)",
        "call ar_empowered (unconditional)",
        "call ar_brand_window (if charred_flesh & brand ticking)",
        "call ar_ur_fishing (if ur_fishing variable)",
        "call ar_cooldowns (unconditional)",
        "call ar_aoe (if fallout_aoe)",
        "fracture (charge mgmt: charges>=2 & frags<threshold)",
        "spirit_bomb (FD window: frags>=3 & fiery_demise_active)",
        "spirit_bomb (normal: frags>=threshold)",
        "fracture (meta priority)",
        "fracture (ungated)",
        "felblade",
        "immolation_aura (fallout)",
        "sigil_of_flame",
        "soul_cleave",
        "immolation_aura (filler)",
        "vengeful_retreat",
        "throw_glaive"
      ],
      "ar_empowered": [
        "reavers_glaive (if RG buff up & neither empowered buff up)",
        "fracture (if both empowered buffs up — applies Reaver's Mark)",
        "soul_cleave (if GF up & RS consumed — triggers Fury of the Aldrachi)",
        "fracture (if RS up & GF consumed — handles SC-first ordering)"
      ],
      "ar_cooldowns": [
        "fiery_brand (if fiery_demise & charges>=2 OR not ticking)",
        "sigil_of_spite (if frags<=5)",
        "soul_carver (if !fiery_demise OR fiery_demise_active)",
        "fel_devastation (if !empowered buffs)"
      ],
      "ar_brand_window": [
        "immolation_aura (if not up — Brand extension via Charred Flesh)",
        "soul_carver",
        "sigil_of_spite (if frags<=5)",
        "fel_devastation (if !empowered buffs)"
      ],
      "ar_aoe": [
        "call ar_empowered (unconditional — nested!)",
        "call ar_brand_window (if charred_flesh & brand ticking — nested!)",
        "immolation_aura (if not up — Fallout frag gen)",
        "spirit_bomb (frags>=threshold)",
        "fracture (meta)",
        "sigil_of_flame",
        "fracture (ungated)",
        "felblade",
        "soul_cleave",
        "immolation_aura (filler)",
        "vengeful_retreat",
        "throw_glaive"
      ],
      "ar_ur_fishing": [
        "spirit_bomb (seething_anger up & frags>=3)",
        "spirit_bomb (frags>=4)",
        "sigil_of_spite (if frags<=2)",
        "soul_carver (if frags<=2)",
        "fracture",
        "soul_cleave (if frags>=1 — fallback proc trigger)"
      ],
      "anni": [
        "trinkets (3 lines)",
        "potion (voidfall_spending stack=3)",
        "call externals (voidfall_spending stack=3)",
        "call anni_voidfall (unconditional)",
        "metamorphosis (off-GCD: if !meta OR UR proc, AND !voidfall_spending)",
        "call anni_ur_fishing (if ur_fishing variable)",
        "fiery_brand (if fiery_demise & !ticking)",
        "immolation_aura (if charred_flesh & brand ticking — inline brand window!)",
        "sigil_of_spite",
        "soul_carver",
        "fel_devastation (if !voidfall_spending)",
        "fracture (charge mgmt)",
        "spirit_bomb (frags>=threshold)",
        "fracture (if !voidfall_spending)",
        "felblade",
        "immolation_aura (fallout)",
        "sigil_of_flame",
        "soul_cleave",
        "fracture (ungated)",
        "immolation_aura (filler)",
        "throw_glaive"
      ],
      "anni_voidfall": [
        "fiery_brand (align Brand with Voidfall peak)",
        "spirit_bomb (spending stack=3 & frags>=threshold)",
        "soul_cleave (spending up & stack<3 — dump individual meteors)",
        "fracture (building stack=2 & fury>=70 — trigger transition)"
      ],
      "anni_ur_fishing": [
        "spirit_bomb (seething_anger & frags>=3)",
        "spirit_bomb (frags>=4)",
        "sigil_of_spite (frags<=2)",
        "soul_carver (frags<=2)",
        "fracture",
        "soul_cleave (frags>=1)"
      ]
    },
    "overlapScenarios": [
      {
        "id": "empowered-before-brand",
        "context": "AR empowered cycle active + Brand ticking (Fiery Demise window)",
        "currentBehavior": "ar_empowered is called unconditionally BEFORE ar_brand_window. If empowered buffs are active (Rending Strike + Glaive Flurry), the empowered cycle fires (Fracture/SC sequence), and the brand window call on line 48 never evaluates because an action already fired this cycle.",
        "problem": "Not actually a problem. The empowered cycle is 2-3 GCDs (Fracture → SC or vice versa) and fires only when buffs are up. Brand window is a longer phase (~10s). The empowered abilities (Fracture, Soul Cleave) are Physical and do NOT benefit from Fiery Demise anyway. The Brand window wants to prioritize Fire-school abilities (ImmAura, Soul Carver, Fel Dev, Sigil of Spite). Spending the empowered GCD on Fracture/SC first, then entering brand window logic for the next GCD, is correct because: (a) empowered buffs have short durations and must be consumed, (b) their Physical damage doesn't benefit from FD. The current ordering is actually optimal.",
        "proposedFix": "No change needed. Current ordering correctly handles both contexts."
      },
      {
        "id": "ur-fishing-before-brand",
        "context": "UR fishing window active + Brand ticking simultaneously",
        "currentBehavior": "ar_brand_window is called before ar_ur_fishing. If Brand is ticking with Charred Flesh, brand window fires first. UR fishing is only evaluated if brand window falls through (all CDs used).",
        "problem": "Minor priority concern. When Meta is about to drop AND Brand is ticking, we face a tension: UR fishing wants fast SBomb casts at fragment threshold 4, while brand window wants to sequence fire CDs for Fiery Demise value. In practice this is rare because Brand CD (60s) and Meta end (~12-15s into 15s Meta) rarely overlap. When they do, Brand window priority is correct because: (a) FD amp is 30% damage increase on fire abilities, (b) UR proc is only ~3.75% chance per SBomb, (c) one SBomb at frags>=4 in brand window is fine for both goals.",
        "proposedFix": "No change needed. Brand window priority over UR fishing is correct for the rare overlap case."
      },
      {
        "id": "aoe-nested-calls",
        "context": "Fallout AoE mode (3+ targets) with empowered cycle + brand window + cooldowns",
        "currentBehavior": "In the main ar list, the call order is: ar_empowered → ar_brand_window → ar_ur_fishing → ar_cooldowns → ar_aoe. If we reach ar_aoe (nothing in the above lists fired), ar_aoe redundantly calls ar_empowered and ar_brand_window again. Since we already checked these and they fell through, the nested calls will also fall through — they are pure waste.",
        "problem": "The nested calls in ar_aoe (lines 96-98) are redundant. They were called and fell through in the parent ar list (lines 46-48) immediately before ar_aoe was called. Since call_action_list is a within-cycle evaluation, and nothing changed between the parent check and the nested check (no GCD elapsed, no state changed), they will always produce the same result. This wastes evaluation cycles.",
        "proposedFix": "Remove the nested ar_empowered and ar_brand_window calls from ar_aoe. They are already handled by the parent ar list before ar_aoe is invoked. This simplifies ar_aoe to focus purely on AoE-specific rotation changes (ImmAura priority, SBomb, Fracture pattern).",
        "caveat": "There IS a scenario where this matters: if ar_aoe were called via run_action_list from somewhere else that DIDN'T first check empowered/brand. But currently ar_aoe is only called from the ar list, which always checks empowered and brand first. If ar_aoe is ever used from another call site, the nested calls would need to be restored. Document this dependency."
      },
      {
        "id": "cooldowns-before-aoe",
        "context": "Cooldowns ready + AoE mode active",
        "currentBehavior": "ar_cooldowns fires before ar_aoe. If Brand is cast via ar_cooldowns, the next cycle will enter ar_brand_window (which fires before ar_cooldowns). If Sigil of Spite or Soul Carver fires, the AoE rotation runs next cycle normally.",
        "problem": "No real problem. Cooldowns should fire as soon as ready regardless of target count. Brand, Soul Carver, Sigil of Spite, and Fel Dev are all valuable abilities that shouldn't be delayed by AoE filler priority. The AoE list only changes the filler rotation (ImmAura priority, different Fracture gating), it doesn't change cooldown priority.",
        "proposedFix": "Current ordering is correct. No change needed."
      },
      {
        "id": "ur-fishing-vs-aoe",
        "context": "UR fishing + AoE mode active (Meta dropping + 3+ targets with Fallout)",
        "currentBehavior": "ar_ur_fishing fires before ar_aoe. UR fishing aggressively spends fragments at threshold 4 (or 3 with seething anger), prioritizing fast SBomb casts over optimal AoE fragment pooling.",
        "problem": "Potential tension. In AoE, fragments accumulate faster (Fallout: 60% per ImmAura tick per target), so SBomb at 4 frags is less costly. But UR fishing lowers the threshold to maximize proc attempts, which is correct even in AoE — the UR proc extends Meta, which is worth more than one extra fragment on SBomb. Additionally, UR fishing only happens in the last ~8s of Meta (a rare window), so the AoE inefficiency is time-bounded.",
        "proposedFix": "Current ordering is acceptable. The UR fishing priority is correct because Meta extension value exceeds marginal fragment value. However, the ur_fishing sub-list could be improved: in AoE, fragment generation is much faster, so the fishing window is shorter (fragments accumulate to threshold faster). No structural change needed."
      }
    ],
    "proposedStructure": {
      "description": "The current hierarchy is largely correct. The main cleanup is removing redundant nested calls in ar_aoe.",
      "ar_revised": [
        "trinkets",
        "potion + externals (empowered window)",
        "metamorphosis (off-GCD)",
        "call ar_empowered (unconditional — AR cycle is highest non-trinket priority)",
        "call ar_brand_window (if fiery_demise_active — see brand window fix below)",
        "call ar_ur_fishing (if ur_fishing)",
        "call ar_cooldowns (unconditional)",
        "call ar_aoe (if fallout_aoe) — NO nested empowered/brand calls",
        "fracture (charge management)",
        "spirit_bomb (unified threshold via context-aware variable)",
        "fracture (meta priority)",
        "fracture (ungated)",
        "felblade",
        "immolation_aura (fallout)",
        "sigil_of_flame",
        "soul_cleave",
        "immolation_aura (filler)",
        "vengeful_retreat",
        "throw_glaive"
      ],
      "ar_aoe_revised": [
        "-- nested empowered/brand calls REMOVED --",
        "immolation_aura (if !up — Fallout frag gen priority)",
        "spirit_bomb (frags>=threshold)",
        "fracture (meta)",
        "sigil_of_flame",
        "fracture (ungated)",
        "felblade",
        "soul_cleave",
        "immolation_aura (filler)",
        "vengeful_retreat",
        "throw_glaive"
      ]
    }
  },

  "brandWindowFixes": {
    "currentGate": "talent.charred_flesh&dot.fiery_brand.ticking",
    "problem": "The gate condition conflates two independent mechanics: (1) WHETHER to enter a brand window (requires Fiery Demise for the damage amp), and (2) WHAT to do inside the window (Charred Flesh changes internal priority by adding ImmAura for extension). The current gate uses `talent.charred_flesh` as the entry condition, which means builds with Fiery Demise but without Charred Flesh skip the brand window entirely. These builds still benefit from the +30% Fire damage amp — they just can't extend the window via ImmAura ticks. Additionally, the current gate checks `dot.fiery_brand.ticking` but Brand without Fiery Demise is purely defensive (DR only). The existing `fiery_demise_active` variable already correctly encodes the right condition: `talent.fiery_brand&talent.fiery_demise&dot.fiery_brand.ticking`.",
    "proposedGate": "variable.fiery_demise_active",
    "rationale": "Fiery Demise is the damage amplification that makes a brand window worth entering. Charred Flesh is an internal optimization (extend the window via ImmAura). Separating these concerns: (a) use `fiery_demise_active` as the gate for entering the brand window, (b) inside the brand window, conditionally prioritize ImmAura only if `talent.charred_flesh` is talented.",
    "internalLogicChanges": {
      "withCharredFlesh": "ImmAura top priority (extends Brand via fire ticks) → Soul Carver → Sigil of Spite → Fel Dev. Current behavior preserved.",
      "withoutCharredFlesh": "Soul Carver → Sigil of Spite → Fel Dev → ImmAura (still fire school, still benefits from FD, just no extension mechanic). New behavior — these builds currently skip the brand window entirely.",
      "proposedBrandWindowAPL": [
        "immolation_aura,if=talent.charred_flesh&!buff.immolation_aura.up  -- extension mechanic",
        "soul_carver",
        "sigil_of_spite,if=soul_fragments<=5",
        "fel_devastation,if=!buff.rending_strike.up&!buff.glaive_flurry.up",
        "immolation_aura,if=!talent.charred_flesh  -- still fire school, FD value, just lower priority without extension"
      ]
    },
    "anniConsistency": {
      "currentAnniLogic": "Lines 147-149: `fiery_brand,if=talent.fiery_demise&!dot.fiery_brand.ticking` followed by `immolation_aura,if=talent.charred_flesh&dot.fiery_brand.ticking`. This is inline brand logic without a sub-list.",
      "problem": "The Anni branch correctly uses `talent.fiery_demise` as the Brand cast condition but only does ImmAura for Charred Flesh extension — it doesn't prioritize other fire CDs during the Brand window (Soul Carver and Sigil of Spite are cast unconditionally earlier in the Anni list, which may or may not align with Brand). This is less impactful for Anni because Voidfall cycle timing dominates CD sequencing, but it's still a missed optimization.",
      "recommendation": "Consider extracting a shared brand_window sub-list that both AR and Anni can call. The gate would be `variable.fiery_demise_active` for both. Internal priority would differ slightly (Anni skips empowered check). See shared-logic analysis for cross-hero architecture."
    },
    "impactEstimate": "Low-to-moderate. Most competitive builds take both Fiery Demise AND Charred Flesh together (they're adjacent in the talent tree). The fix matters for: (a) theoretical builds with FD but not CF, (b) correctness/maintainability."
  },

  "spiritBombUnification": {
    "currentLines": {
      "ar_line59": "spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active",
      "ar_line60": "spirit_bomb,if=soul_fragments>=variable.spb_threshold",
      "comment": "Two separate SBomb lines in the AR section. Line 59 uses threshold 3 during Fiery Demise windows. Line 60 uses the variable threshold (5, or 4 during UR fishing)."
    },
    "contextInteraction": {
      "normalPlay": "spb_threshold=5. SBomb at 5 frags.",
      "urFishing": "spb_threshold=4 (Meta up, remains<8, UR talented). SBomb at 4 frags. Correct — more SBomb casts = more UR proc attempts.",
      "fieryDemise": "SBomb at 3 frags. Correct — FD's 30% fire amp makes 3-frag casts worth the GCD.",
      "urFishing_AND_fieryDemise": "Both contexts overlap when Meta is dropping AND Brand is ticking. Line 59 fires first (threshold 3), so the UR threshold of 4 is irrelevant. This is CORRECT because: (a) FD amp on a 3-frag SBomb (3 × 1.3 = 3.9 effective frags) exceeds the 4-frag UR threshold, (b) lower threshold means MORE SBomb casts which also helps UR fishing, (c) the SBomb still counts as a UR proc attempt regardless of fragment count."
    },
    "proposedVariable": {
      "description": "Absorb the FD threshold into the spb_threshold variable itself, making it context-aware across all three states. Order matters — later op=set overwrites earlier ones, so the HIGHEST priority context must be last.",
      "definition": [
        "variable,name=spb_threshold,value=5",
        "variable,name=spb_threshold,op=set,value=4,if=talent.untethered_rage&buff.metamorphosis.up&buff.metamorphosis.remains<8",
        "variable,name=spb_threshold,op=set,value=3,if=variable.fiery_demise_active"
      ],
      "contextPriorityReasoning": "FD threshold (3) takes priority over UR fishing (4) because: (1) FD's 30% amp makes 3-frag casts efficient (effective value 3.9 > 4 base), (2) lower threshold generates MORE SBomb casts which simultaneously helps UR fishing, (3) both goals are aligned — no conflict. The op=set ordering ensures FD (value=3) overwrites UR (value=4) when both are active.",
      "proposedLine": "spirit_bomb,if=soul_fragments>=variable.spb_threshold",
      "linesRemoved": "spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active (line 59) — absorbed into variable"
    },
    "anniImplication": {
      "currentAnni": "Anni uses only `spirit_bomb,if=soul_fragments>=variable.spb_threshold` (line 157). No separate FD line exists for Anni.",
      "reason": "Build-theory.json notes: 'Static threshold 5 beats dynamic 3/5 for Anni.' This is because Anni's Voidfall cycle dictates when SBomb fires (spending stack=3 triggers), and the Voidfall sub-list handles SBomb timing independently. The FD overlap with Voidfall spending is already handled in anni_voidfall (line 172: Brand alignment before spending peak). Adding a lower FD threshold to Anni's main rotation would interfere with Voidfall cycle timing.",
      "recommendation": "Keep Anni as-is with static threshold. The FD threshold unification only applies to the AR branch."
    },
    "urFishingSubListImplication": {
      "currentBehavior": "ar_ur_fishing has its own SBomb lines: `spirit_bomb,if=buff.seething_anger.up&soul_fragments>=3` and `spirit_bomb,if=soul_fragments>=4`. These use hardcoded thresholds 3 and 4.",
      "withUnifiedVariable": "If spb_threshold is now context-aware (4 during UR fishing, 3 during FD), the ur_fishing sub-list's SBomb at frags>=4 is redundant with the main rotation's SBomb at frags>=variable.spb_threshold (which is 4 during UR). The seething_anger line (frags>=3) is a further override specific to bad-luck-protection. This could be: (a) kept as-is in the sub-list for clarity, or (b) absorbed into the variable with another op=set for seething_anger. Recommendation: keep the seething_anger override in the sub-list because it's UR-fishing-specific logic that doesn't belong in the global variable."
    }
  },

  "redundancyAudit": [
    {
      "id": "ar-aoe-nested-empowered",
      "lines": {
        "ar_line46": "call_action_list,name=ar_empowered",
        "ar_aoe_line96": "call_action_list,name=ar_empowered"
      },
      "redundant": true,
      "reason": "ar_aoe is only called from the ar list (line 54), which already calls ar_empowered (line 46) before reaching ar_aoe. Since call_action_list evaluates within the same cycle, if ar_empowered fell through in the parent, it will also fall through in ar_aoe — no state has changed between the two calls. The nested call is dead code in the current architecture.",
      "recommendation": "REMOVE the nested ar_empowered call from ar_aoe (line 96). Add a comment noting the dependency: '# ar_empowered already checked by parent ar list before reaching ar_aoe'."
    },
    {
      "id": "ar-aoe-nested-brand",
      "lines": {
        "ar_line48": "call_action_list,name=ar_brand_window,if=talent.charred_flesh&dot.fiery_brand.ticking",
        "ar_aoe_line98": "call_action_list,name=ar_brand_window,if=talent.charred_flesh&dot.fiery_brand.ticking"
      },
      "redundant": true,
      "reason": "Same reasoning as the empowered case above. ar_brand_window was already called with the same condition in the parent ar list (line 48). If it fell through or wasn't entered, the nested call in ar_aoe will produce the same result.",
      "recommendation": "REMOVE the nested ar_brand_window call from ar_aoe (line 98). Same dependency note."
    },
    {
      "id": "ar-fracture-meta-vs-ungated",
      "lines": {
        "ar_line62": "fracture,if=buff.metamorphosis.up",
        "ar_line64": "fracture"
      },
      "redundant": false,
      "reason": "These lines are NOT redundant despite both being Fracture. They establish priority ordering: Fracture-in-Meta (line 62) fires BEFORE Felblade (line 66), while ungated Fracture (line 64) also fires before Felblade. Wait — looking at the actual APL again: line 62 is Fracture(meta), line 64 is Fracture(ungated), line 66 is Felblade. So BOTH Fractures fire before Felblade, meaning the Meta guard on line 62 is meaningless — the ungated Fracture on line 64 will also fire before Felblade regardless of Meta status. The Meta-gated Fracture is truly redundant with the ungated Fracture that immediately follows it.",
      "recommendation": "REMOVE line 62 (fracture,if=buff.metamorphosis.up). The ungated Fracture on line 64 already fires before Felblade, making the Meta guard irrelevant. In the current line ordering (Spirit Bomb → Fracture(meta) → Fracture(ungated) → Felblade), Fracture always fires before Felblade. The Meta-gated version was likely meaningful in an earlier APL version where Felblade was between the two Fractures."
    },
    {
      "id": "ar-aoe-fracture-meta-vs-ungated",
      "lines": {
        "ar_aoe_line102": "fracture,if=buff.metamorphosis.up",
        "ar_aoe_line104": "fracture"
      },
      "redundant": true,
      "reason": "Same issue as the main AR list. In ar_aoe, line 102 (Fracture-meta) and line 104 (Fracture-ungated) are adjacent with only sigil_of_flame between them. The Meta guard is meaningless because the ungated Fracture will fire on the same GCD if Meta isn't up. Actually wait — there IS sigil_of_flame between them (line 103). So the ordering is: Fracture(meta) → Sigil of Flame → Fracture(ungated). This means: during Meta, Fracture fires OVER Sigil of Flame. Outside Meta, Sigil of Flame fires first, then Fracture. This IS meaningful — Meta-Fracture generates 3 fragments (vs 2 outside) and is worth prioritizing over Sigil of Flame's fire damage/frag. The Meta guard establishes Fracture > SoF priority during Meta.",
      "recommendation": "KEEP. This is NOT redundant. The Meta guard correctly prioritizes 3-frag Fracture over Sigil of Flame during Meta. Correction to my initial assessment."
    },
    {
      "id": "ar-spirit-bomb-fd-vs-normal",
      "lines": {
        "ar_line59": "spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active",
        "ar_line60": "spirit_bomb,if=soul_fragments>=variable.spb_threshold"
      },
      "redundant": false,
      "reason": "These are contextually different thresholds. Line 59 fires at 3 frags during FD windows (rare, high-value). Line 60 fires at 5 (or 4 during UR fishing). They serve different purposes. However, they CAN be unified into a single context-aware variable as described in spiritBombUnification above.",
      "recommendation": "MERGE into single line via context-aware spb_threshold variable. See spiritBombUnification section."
    },
    {
      "id": "ar-fracture-charge-mgmt-vs-meta-vs-ungated",
      "lines": {
        "ar_line56": "fracture,if=cooldown.fracture.charges>=2&soul_fragments<variable.spb_threshold",
        "ar_line62": "fracture,if=buff.metamorphosis.up",
        "ar_line64": "fracture"
      },
      "redundant": false,
      "reason": "Three Fracture lines with different purposes: (1) Charge management: prevents capping charges while respecting fragment ceiling. Fires BEFORE Spirit Bomb, ensuring we generate frags for SBomb. (2) Meta priority: prioritizes Fracture over... nothing useful (see ar-fracture-meta-vs-ungated). (3) Ungated: fills remaining GCDs with Fracture. Lines 1 and 3 are genuinely different (charge management fires with different gating). Line 2 is redundant as analyzed above.",
      "recommendation": "Keep lines 56 and 64. Remove line 62 (Meta priority) since it's redundant with line 64. Net result: charge-management Fracture → Spirit Bomb → ungated Fracture → Felblade."
    },
    {
      "id": "ur-fishing-duplication-ar-vs-anni",
      "lines": {
        "ar_ur_fishing": "lines 122-129",
        "anni_ur_fishing": "lines 183-188"
      },
      "redundant": false,
      "reason": "ar_ur_fishing and anni_ur_fishing are IDENTICAL in logic (same 6 lines with same conditions). They exist as separate sub-lists only because they live in different hero-tree branches. This is a maintenance burden — any change to UR fishing logic must be applied to both lists.",
      "recommendation": "Extract a shared ur_fishing sub-list that both hero trees call. This is a cross-hero-tree shared logic opportunity. See shared-logic analysis. Implementation: create `actions.ur_fishing` and call from both `ar` and `anni` via `call_action_list,name=ur_fishing,if=variable.ur_fishing`."
    },
    {
      "id": "anni-fracture-voidfall-vs-ungated",
      "lines": {
        "anni_line159": "fracture,if=!buff.voidfall_spending.up",
        "anni_line166": "fracture"
      },
      "redundant": false,
      "reason": "Line 159 gates Fracture behind !voidfall_spending because during Voidfall spending phase, you want Soul Cleave (triggers meteors) not Fracture (generates fragments). But after Felblade, ImmAura, Sigil of Flame, and Soul Cleave have all been checked (or fired), the ungated Fracture on line 166 serves as absolute filler. During Voidfall spending, line 159 falls through, Soul Cleave fires (line 164), so line 166 is rarely reached during spending. It exists as a safety net for edge cases (no Fury for Soul Cleave, all abilities on CD).",
      "recommendation": "KEEP. The Voidfall guard on line 159 is meaningful. The ungated Fracture on line 166 is a necessary safety net."
    },
    {
      "id": "anni-inline-brand-vs-ar-brand-sublist",
      "lines": {
        "anni_line147": "fiery_brand,if=talent.fiery_demise&!dot.fiery_brand.ticking",
        "anni_line149": "immolation_aura,if=talent.charred_flesh&dot.fiery_brand.ticking",
        "ar_brand_window": "4-line sub-list (ImmAura, Soul Carver, Sigil of Spite, Fel Dev)"
      },
      "redundant": false,
      "reason": "The Anni branch uses inline Brand logic (2 lines) while AR uses a dedicated sub-list (4 lines). The AR brand window is more comprehensive (prioritizes multiple fire CDs), while Anni only does ImmAura extension. This asymmetry exists because Anni's Voidfall cycle handles Soul Carver and Sigil of Spite timing independently, so they don't need to be sequenced into a brand window. However, this means Anni may not optimally align fire CDs with Brand when possible.",
      "recommendation": "Consider a lightweight shared brand-window approach for Anni that includes Fel Dev alignment when not in Voidfall spending. Low priority — Voidfall cycle timing dominates Anni CD sequencing."
    },
    {
      "id": "simc-reference-comparison-missing-spirit-bomb",
      "lines": {
        "reference_ar_line72": "spirit_bomb,if=spell_targets>=12&soul_fragments>=4",
        "our_ar": "spirit_bomb,if=soul_fragments>=3&variable.fiery_demise_active / spirit_bomb,if=soul_fragments>=variable.spb_threshold"
      },
      "redundant": false,
      "reason": "The SimC reference APL relegates Spirit Bomb to 12+ targets only for AR, treating Soul Cleave as the primary spender. Our APL correctly identifies Spirit Bomb as a core rotation ability with Frailty application value, not just an AoE filler. This is a design philosophy difference, not a redundancy. Our approach is validated by simulation — Spirit Bomb at 5-frag threshold is core to the Fragment Engine archetype.",
      "recommendation": "No change. Our Spirit Bomb handling is superior to the reference APL. The reference APL's 12-target gate is overly restrictive."
    },
    {
      "id": "simc-reference-missing-ur-fishing",
      "lines": {
        "reference": "(no UR fishing logic)",
        "our": "ar_ur_fishing / anni_ur_fishing sub-lists"
      },
      "redundant": false,
      "reason": "The SimC reference APL has no Untethered Rage fishing logic at all. Our APL adds dedicated sub-lists for maximizing UR proc chance when Meta is about to expire. This is a net-new feature in our APL.",
      "recommendation": "No change. UR fishing is a validated improvement over the reference APL."
    }
  ],

  "summary": {
    "confirmedRedundancies": [
      {
        "item": "ar_aoe nested ar_empowered call (line 96)",
        "action": "Remove",
        "impact": "Eliminates dead evaluation cycles"
      },
      {
        "item": "ar_aoe nested ar_brand_window call (line 98)",
        "action": "Remove",
        "impact": "Eliminates dead evaluation cycles"
      },
      {
        "item": "AR Fracture-in-Meta (line 62) — ungated Fracture (line 64) immediately follows",
        "action": "Remove line 62",
        "impact": "Simplifies rotation without changing behavior — ungated Fracture already fires before Felblade"
      }
    ],
    "proposedFixes": [
      {
        "item": "Brand window gate: talent.charred_flesh → variable.fiery_demise_active",
        "action": "Change gate condition, add non-CF ImmAura line inside brand window",
        "impact": "Correctness improvement for non-CF Fiery Demise builds"
      },
      {
        "item": "Spirit Bomb FD threshold → absorbed into spb_threshold variable",
        "action": "Add op=set,value=3,if=variable.fiery_demise_active to spb_threshold; remove line 59",
        "impact": "Simplifies APL, unifies threshold logic, same behavior"
      },
      {
        "item": "Shared UR fishing sub-list",
        "action": "Extract common ur_fishing list for both hero trees",
        "impact": "Reduces maintenance burden, ensures consistency"
      }
    ],
    "noChangeNeeded": [
      "Call hierarchy ordering (empowered → brand → UR → CDs → AoE) is correct",
      "ar_aoe Fracture-in-Meta (line 102) is NOT redundant — establishes priority over Sigil of Flame",
      "Anni inline Brand logic is acceptable given Voidfall cycle dominance",
      "Anni Fracture Voidfall guard vs ungated Fracture — both needed",
      "Our Spirit Bomb philosophy vs SimC reference — ours is superior"
    ]
  }
}
