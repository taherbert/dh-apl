# Devourer Demon Hunter APL
# Synced from SimC midnight branch: engine/class_modules/apl/demon_hunter/devourer.simc
# Both hero trees (Void-Scarred / Annihilator) handled via inline talent checks

input=apls/devourer/profile.simc

# Executed before combat begins. Accepts non-harmful actions only.
actions.precombat=snapshot_stats
actions.precombat+=/variable,name=trinket_1_buffs,value=trinket.1.has_buff.intellect|trinket.1.has_buff.mastery|trinket.1.has_buff.versatility|trinket.1.has_buff.haste|trinket.1.has_buff.crit|trinket.1.is.mirror_of_fractured_tomorrows|trinket.1.is.signet_of_the_priory
actions.precombat+=/variable,name=trinket_2_buffs,value=trinket.2.has_buff.intellect|trinket.2.has_buff.mastery|trinket.2.has_buff.versatility|trinket.2.has_buff.haste|trinket.2.has_buff.crit|trinket.2.is.mirror_of_fractured_tomorrows|trinket.2.is.signet_of_the_priory
actions.precombat+=/variable,name=weapon_buffs,value=equipped.bestinslots
actions.precombat+=/variable,name=weapon_sync,op=setif,value=1,value_else=0.5,condition=equipped.bestinslots
actions.precombat+=/variable,name=weapon_stat_value,value=equipped.bestinslots*5142*15
actions.precombat+=/variable,name=trinket_1_manual,value=trinket.1.is.belorrelos_the_suncaller|trinket.1.is.nymues_unraveling_spindle|trinket.1.is.spymasters_web
actions.precombat+=/variable,name=trinket_2_manual,value=trinket.2.is.belorrelos_the_suncaller|trinket.2.is.nymues_unraveling_spindle|trinket.2.is.spymasters_web
actions.precombat+=/variable,name=trinket_1_ogcd_cast,value=0
actions.precombat+=/variable,name=trinket_2_ogcd_cast,value=0
actions.precombat+=/variable,name=trinket_1_exclude,value=trinket.1.is.ruby_whelp_shell|trinket.1.is.whispering_incarnate_icon
actions.precombat+=/variable,name=trinket_2_exclude,value=trinket.2.is.ruby_whelp_shell|trinket.2.is.whispering_incarnate_icon
actions.precombat+=/variable,name=trinket_priority,op=setif,value=2,value_else=1,condition=!variable.trinket_1_buffs&variable.trinket_2_buffs|variable.trinket_2_buffs&((trinket.2.proc.any_dps.duration)*trinket.2.proc.any_dps.default_value)>((trinket.1.proc.any_dps.duration)*trinket.1.proc.any_dps.default_value)
actions.precombat+=/variable,name=trinket_priority,op=setif,if=variable.weapon_buffs,value=3,value_else=variable.trinket_priority,condition=!variable.trinket_1_buffs&!variable.trinket_2_buffs|variable.weapon_stat_value>(((trinket.2.proc.any_dps.duration)*trinket.2.proc.any_dps.default_value)<?((trinket.1.proc.any_dps.duration)*trinket.1.proc.any_dps.default_value))
actions.precombat+=/variable,name=trinket_priority,op=set,value=trinket.1.is.signet_of_the_priory+2*trinket.2.is.signet_of_the_priory,if=equipped.signet_of_the_priory&variable.trinket_priority=3
actions.precombat+=/variable,name=damage_trinket_priority,op=setif,value=2,value_else=1,condition=!variable.trinket_1_buffs&!variable.trinket_2_buffs&trinket.2.ilvl>=trinket.1.ilvl
actions.precombat+=/variable,name=should_use_star,default=0,value=0,op=reset
actions.precombat+=/arcane_torrent
actions.precombat+=/consume

# Executed every time the actor is available.
actions=call_action_list,name=math_for_wizards
actions+=/call_action_list,name=illicit_doping
actions+=/voidblade,if=buff.void_metamorphosis_stack.at_max_stacks
actions+=/the_hunt,if=buff.void_metamorphosis_stack.at_max_stacks
actions+=/metamorphosis
actions+=/void_ray
# DB+Voidrush: CStar when PtV ready, PW on CD, not in HS chain. Non-DB: always. DB+no-Voidrush: when not in HS chain.
actions+=/collapsing_star,if=(!buff.hungering_slash.up&(talent.voidrush&cooldown.pierce_the_veil.up&cooldown.predators_wake.remains|!talent.voidrush)|!talent.devourers_bite)&variable.should_use_star&(!talent.voidrush|cooldown.voidblade.remains>=6|buff.collapsing_star_stacking.stack>=38)
# In AoE, Eradicate's 25yd cone outprioritizes DB debuff application
actions+=/eradicate,if=active_enemies>1
actions+=/call_action_list,name=melee_combo,if=talent.devourers_bite
# Voidfall spending Eradicate in ST
actions+=/eradicate,if=buff.voidfall_spending.react
actions+=/call_action_list,name=melee_combo
actions+=/call_action_list,name=reaps,if=buff.voidfall_spending.react
# Reap to generate a Collapsing Star quicker
actions+=/call_action_list,name=reaps,if=soul_fragments>=4&(!buff.metamorphosis.up&(buff.void_metamorphosis_stack.stack+action.reap.souls_consumed)>=buff.void_metamorphosis_stack.max_stack|!talent.voidfall&buff.metamorphosis.up&!buff.collapsing_star_ready.up&(buff.collapsing_star_stacking.stack+action.reap.souls_consumed>=30)&variable.should_use_star)
# Reap good in meta for VS
actions+=/call_action_list,name=reaps,if=action.reap.souls_consumed>=4&!talent.voidfall&buff.metamorphosis.up&(!buff.moment_of_craving.up|action.reap.souls_consumed>=9|!variable.should_use_star)
# Consume Eradicate proc before VR overwrites it
actions+=/call_action_list,name=reaps,if=buff.eradicate.up
# Voidfall: reap in ST during Meta when spending phase has ended
actions+=/call_action_list,name=reaps,if=talent.voidfall&buff.metamorphosis.up&active_enemies=1&!buff.voidfall_spending.react&action.reap.souls_consumed>=4
actions+=/soul_immolation,if=refreshable&!buff.metamorphosis.up
actions+=/devour
actions+=/consume

actions.illicit_doping=invoke_external_buff,name=power_infusion,if=buff.metamorphosis.up&!buff.power_infusion.up
actions.illicit_doping+=/potion,if=buff.metamorphosis.up|fight_remains<=30
actions.illicit_doping+=/use_item,slot=trinket1,if=buff.metamorphosis.up&(!trinket.2.has_cooldown|trinket.2.cooldown.remains|variable.trinket_priority=1|variable.trinket_2_exclude)&!variable.trinket_1_manual|trinket.1.proc.any_dps.duration>=fight_remains
actions.illicit_doping+=/use_item,slot=trinket2,if=buff.metamorphosis.up&(!trinket.1.has_cooldown|trinket.1.cooldown.remains|variable.trinket_priority=2|variable.trinket_1_exclude)&!variable.trinket_2_manual|trinket.2.proc.any_dps.duration>=fight_remains
actions.illicit_doping+=/use_item,slot=main_hand,if=variable.weapon_buffs&(variable.trinket_2_buffs&(trinket.2.cooldown.remains|trinket.2.cooldown.duration<=20)|!variable.trinket_2_buffs|variable.trinket_2_exclude|variable.trinket_priority=3)&(variable.trinket_1_buffs&(trinket.1.cooldown.remains|trinket.1.cooldown.duration<=20)|!variable.trinket_1_buffs|variable.trinket_1_exclude|variable.trinket_priority=3)
actions.illicit_doping+=/use_item,use_off_gcd=1,slot=trinket1,if=!variable.trinket_1_buffs&!variable.trinket_1_manual&(variable.damage_trinket_priority=1|trinket.2.cooldown.remains|trinket.2.is.spymasters_web|trinket.2.cooldown.duration=0)&(gcd.remains>0.1)
actions.illicit_doping+=/use_item,use_off_gcd=1,slot=trinket2,if=!variable.trinket_2_buffs&!variable.trinket_2_manual&(variable.damage_trinket_priority=2|trinket.1.cooldown.remains|trinket.1.is.spymasters_web|trinket.1.cooldown.duration=0)&(gcd.remains>0.1)
actions.illicit_doping+=/use_item,slot=trinket1,if=!variable.trinket_1_buffs&!variable.trinket_1_manual&(variable.damage_trinket_priority=1|trinket.2.cooldown.remains|trinket.2.is.spymasters_web|trinket.2.cooldown.duration=0)&(!variable.trinket_1_ogcd_cast)
actions.illicit_doping+=/use_item,slot=trinket2,if=!variable.trinket_2_buffs&!variable.trinket_2_manual&(variable.damage_trinket_priority=2|trinket.1.cooldown.remains|trinket.1.is.spymasters_web|trinket.1.cooldown.duration=0)&(!variable.trinket_2_ogcd_cast)

actions.math_for_wizards=variable,name=should_use_star,op=set,value=active_enemies>1|apex.1|buff.dark_matter.up|talent.star_fragments&talent.emptiness,if=talent.collapsing_star

actions.melee_combo=vengeful_retreat,if=buff.voidstep.up
actions.melee_combo+=/hungering_slash
actions.melee_combo+=/reapers_toll
actions.melee_combo+=/the_hunt,if=active_enemies>1
actions.melee_combo+=/pierce_the_veil
actions.melee_combo+=/predators_wake
# Allow VB during Meta in ST for DB builds â€” Violent Transformation reset the CD
actions.melee_combo+=/voidblade,if=(talent.duty_eternal&active_enemies=1|talent.hungering_slash)&(!talent.devourers_bite|active_enemies>1|buff.metamorphosis.up)

actions.reaps=eradicate
actions.reaps+=/cull
actions.reaps+=/reap
